<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>syncell.trajectory &mdash; syncell 0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> syncell
          </a>
              <div class="version">
                0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">syncell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">syncell</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>syncell.trajectory</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for syncell.trajectory</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">;</span> <span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">coo_matrix</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="c1">#matplotlib.use(&#39;TkAgg&#39;)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyemma.coordinates</span> <span class="k">as</span> <span class="nn">coor</span>
<span class="kn">import</span> <span class="nn">pyemma.coordinates.clustering</span> <span class="k">as</span> <span class="nn">clustering</span>
<span class="kn">import</span> <span class="nn">pyemma</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">transform</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">csaps</span>
<span class="kn">import</span> <span class="nn">mahotas</span>
<span class="kn">import</span> <span class="nn">mahotas.labeled</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">pystackreg</span> <span class="kn">import</span> <span class="n">StackReg</span>
<span class="kn">import</span> <span class="nn">pyemma.coordinates</span> <span class="k">as</span> <span class="nn">coor</span>
<span class="kn">import</span> <span class="nn">numpy.matlib</span>


<div class="viewcode-block" id="Trajectory"><a class="viewcode-back" href="../../stubs/syncell.trajectory.Trajectory.html#syncell.trajectory.Trajectory">[docs]</a><span class="k">class</span> <span class="nc">Trajectory</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A toolset for single-cell trajectory modeling. See:</span>
<span class="sd">    </span>
<span class="sd">    Danger</span>
<span class="sd">    -------</span>
<span class="sd">    This code, currently, should be considered as an untested pre-release version</span>
<span class="sd">    </span>
<span class="sd">    Todo</span>
<span class="sd">    ----</span>
<span class="sd">    Refactor</span>
<span class="sd">        In general, this class&#39;s methods generally handle data by holding state in the object.</span>
<span class="sd">        The functions that update state with the result of a calculation, though, tend to update a lot of state on the way.</span>
<span class="sd">        The state being updated along the way is usually &quot;helper&quot; quantities.</span>
<span class="sd">        I think it would be prudent to refactor these in such a way that these are updated in as few places as possible --</span>
<span class="sd">        one example of this might be setting them as properties, and then updating the value in state as part of that</span>
<span class="sd">        accessor if necessary.</span>
<span class="sd">    References</span>
<span class="sd">    --------</span>
<span class="sd">    Jeremy Copperman, Sean M. Gross, Young Hwan Chang, Laura M. Heiser, and Daniel M. Zuckerman. </span>
<span class="sd">    Morphodynamical cell-state description via live-cell imaging trajectory embedding. </span>
<span class="sd">    Biorxiv 10.1101/2021.10.07.463498, 2021.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Trajectory.__init__"><a class="viewcode-back" href="../../stubs/syncell.trajectory.Trajectory.html#syncell.trajectory.Trajectory.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Work-in-progress init function. For now, just start adding attribute definitions in here.</span>
<span class="sd">        Todo</span>
<span class="sd">        ----</span>
<span class="sd">        - Most logic from initialize() should be moved in here.</span>
<span class="sd">        - Also, comment all of these here. Right now most of them have comments throughout the code.</span>
<span class="sd">        - Reorganize these attributes into some meaningful structure</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileSpecifier</span><span class="p">,</span><span class="n">modelName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of :class:`bluepy.blte.Service` objects representing</span>
<span class="sd">        the services offered by the device. This will perform Bluetooth service</span>
<span class="sd">        discovery if this has not already been done; otherwise it will return a</span>
<span class="sd">        cached list of services immediately..</span>

<span class="sd">        :param uuids: A list of string service UUIDs to be discovered,</span>
<span class="sd">            defaults to None</span>
<span class="sd">        :type uuids: list, optional</span>
<span class="sd">        :return: A list of the discovered :class:`bluepy.blte.Service` objects,</span>
<span class="sd">            which match the provided ``uuids``</span>
<span class="sd">        :rtype: list On Python 3.x, this returns a dictionary view object,</span>
<span class="sd">            not a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">=</span><span class="n">modelName</span>
        <span class="n">pCommand</span><span class="o">=</span><span class="s1">&#39;ls &#39;</span><span class="o">+</span><span class="n">fileSpecifier</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">pCommand</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">fileList</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fileList</span><span class="o">=</span><span class="n">fileList</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="o">=</span><span class="n">fileList</span>
        <span class="n">nF</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fileList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="o">=</span><span class="n">nF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgdim</span><span class="o">=</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgchannel</span><span class="o">=</span><span class="kc">None</span> <span class="c1">#None for single-channel images, or chosen channel for multi-channel images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="o">=</span><span class="kc">None</span> <span class="c1">#None for single-channel masks, or chosen channel for multi-channel masks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maximum_cell_size</span><span class="o">=</span><span class="mi">250</span> <span class="c1">#biggest linear edge of square holding a single cell image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntrans</span><span class="o">=</span><span class="mi">30</span><span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxtrans</span><span class="o">=</span><span class="mf">60.0</span> <span class="c1">#sqrt number of points and max value for brute force registration</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagesExist</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;problem getting images </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagesExist</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">def</span> <span class="nf">get_image_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Example function with PEP 484 type annotations.</span>
<span class="sd">        The return type must be duplicated in the docstring to comply</span>
<span class="sd">        with the NumPy docstring style.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param1</span>
<span class="sd">            The first parameter.</span>
<span class="sd">        param2</span>
<span class="sd">            The second parameter.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frame</span><span class="o">=</span><span class="n">n_frame</span>
        <span class="n">nF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span>
        <span class="n">timeList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">imgfileList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">imgs</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nF</span>
        <span class="n">msks</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nF</span>
        <span class="n">e_images</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nF</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iF</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">):</span>
            <span class="n">fileName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataIn</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/image&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">dsetName</span> <span class="ow">in</span> <span class="n">dataIn</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">e_images</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">dset</span><span class="o">=</span><span class="n">dataIn</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                    <span class="n">imgs</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                    <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/mask&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                    <span class="n">dset</span><span class="o">=</span><span class="n">dataIn</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                    <span class="n">msks</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
                    <span class="n">timeList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timeList</span><span class="p">,</span><span class="n">time</span><span class="p">)</span>
                    <span class="n">imgfileList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgfileList</span><span class="p">,</span><span class="n">iF</span><span class="p">)</span>
                <span class="n">dataIn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;error in &#39;</span><span class="o">+</span><span class="n">fileName</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">indimages</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e_images</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="n">msks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">msks</span><span class="p">)</span>
        <span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">[</span><span class="n">indimages</span><span class="p">]</span>
        <span class="n">msks</span><span class="o">=</span><span class="n">msks</span><span class="p">[</span><span class="n">indimages</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">imgs</span><span class="o">.</span><span class="n">ndim</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">imgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">msks</span><span class="o">=</span><span class="n">msks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">msks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">msks</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#        if imgs.ndim==&gt;3: #throwing out extra channels for now</span>
<span class="c1">#            imgs=imgs[0,:,:,0]</span>
<span class="c1">#            imgs=np.expand_dims(imgs,axis=0)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgchannel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">[:,:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">imgchannel</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msks</span><span class="o">=</span><span class="n">msks</span><span class="p">[:,:,:,</span><span class="bp">self</span><span class="o">.</span><span class="n">mskchannel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msks</span><span class="o">=</span><span class="n">msks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeList</span><span class="o">=</span><span class="n">timeList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgfileList</span><span class="o">=</span><span class="n">imgfileList</span>

    <span class="k">def</span> <span class="nf">get_fmask_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_frame</span><span class="p">):</span> <span class="c1">#get foreground masks</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of :class:`bluepy.blte.Service` objects representing</span>
<span class="sd">        the services offered by the device. This will perform Bluetooth service</span>
<span class="sd">        discovery if this has not already been done; otherwise it will return a</span>
<span class="sd">        cached list of services immediately..</span>

<span class="sd">        :param uuids: A list of string service UUIDs to be discovered,</span>
<span class="sd">            defaults to None</span>
<span class="sd">        :type uuids: list, optional</span>
<span class="sd">        :return: A list of the discovered :class:`bluepy.blte.Service` objects,</span>
<span class="sd">            which match the provided ``uuids``</span>
<span class="sd">        :rtype: list On Python 3.x, this returns a dictionary view object,</span>
<span class="sd">            not a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frame</span><span class="o">=</span><span class="n">n_frame</span>
        <span class="n">nF</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span>
        <span class="n">fmsks</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nF</span>
        <span class="n">e_images</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nF</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iF</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">):</span>
            <span class="n">fileName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataIn</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/image&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">dsetName</span> <span class="ow">in</span> <span class="n">dataIn</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">e_images</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
                    <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/fmsk&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                    <span class="n">dset</span><span class="o">=</span><span class="n">dataIn</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                    <span class="n">fmsks</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
                <span class="n">dataIn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;error in &#39;</span><span class="o">+</span><span class="n">fileName</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">indimages</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">e_images</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fmsks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fmsks</span><span class="p">)</span>
        <span class="n">fmsks</span><span class="o">=</span><span class="n">fmsks</span><span class="p">[</span><span class="n">indimages</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fmsks</span><span class="o">.</span><span class="n">ndim</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">fmsks</span><span class="o">=</span><span class="n">fmsks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fmsks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">fmsks</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmsks</span><span class="o">=</span><span class="n">fmsks</span>

    <span class="k">def</span> <span class="nf">get_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">numFiles</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">numImages</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">frameList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">nImage</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">n_frame</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">nImage</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nImage</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">iF</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">):</span>
                <span class="n">fileName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">iF</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataIn</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">dsetName</span> <span class="o">=</span> <span class="s2">&quot;/images/img_</span><span class="si">%d</span><span class="s2">/image&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">dsetName</span> <span class="ow">in</span> <span class="n">dataIn</span>
                    <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">nImage</span><span class="o">=</span><span class="n">nImage</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">dataIn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;no images in &#39;</span><span class="o">+</span><span class="n">fileName</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nImage</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">numImages</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numImages</span><span class="p">,</span><span class="n">nImage</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_frame</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; has &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nImage</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; images...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">n_frame</span><span class="o">=</span><span class="n">n_frame</span><span class="o">+</span><span class="mi">1</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">numImages</span><span class="o">=</span><span class="n">numImages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxFrame</span><span class="o">=</span><span class="n">numImages</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_cell_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msk</span><span class="p">,</span><span class="n">minsize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">ncells</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk</span><span class="p">))</span>
        <span class="n">cellblocks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imgdim</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ncells</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">indc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">msk</span><span class="o">==</span><span class="n">ic</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">indc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&lt;</span><span class="n">minsize</span><span class="p">:</span> <span class="c1">#==0:</span>
                <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indgood</span><span class="p">,</span><span class="n">ic</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgdim</span><span class="p">):</span>
                    <span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">idim</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indc</span><span class="p">[</span><span class="n">idim</span><span class="p">])</span>
                    <span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">idim</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indc</span><span class="p">[</span><span class="n">idim</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cell: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; smaller than minsize of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minsize</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">indgood</span><span class="o">=</span><span class="n">indgood</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">cellblocks</span><span class="o">=</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">indgood</span><span class="p">,:,:]</span>
        <span class="k">return</span> <span class="n">cellblocks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_cells_from_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="n">msk</span><span class="p">,</span><span class="n">cellblocks</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgdim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
            <span class="n">ncells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="n">nb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
            <span class="n">ncells</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncells</span><span class="p">):</span>
                <span class="n">imgcell</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
                <span class="n">imgcell</span><span class="o">=</span><span class="n">imgcell</span><span class="p">[:,</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">mskcell</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
                <span class="n">mskcell</span><span class="o">=</span><span class="n">mskcell</span><span class="p">[:,</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> 
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">nb</span><span class="p">,</span><span class="n">ic</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgcell</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mskcell</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;not in visual mode...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_imageSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_frame</span><span class="p">,</span><span class="n">end_frame</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;getting images frame: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msks</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileList</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="o">=</span><span class="n">start_frame</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeList</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="o">=</span><span class="n">start_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="o">=</span><span class="n">end_frame</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">end_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;getting images frame: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_image_data</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">msks</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileList</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="p">,</span><span class="n">iS</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileList</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeList</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_fmaskSet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_frame</span><span class="p">,</span><span class="n">end_frame</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;getting foreground masks frame: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_fmask_data</span><span class="p">(</span><span class="n">start_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmsks</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">end_frame</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;getting foreground masks frame: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_fmask_data</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fmsks</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_imageSet_trans_turboreg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nimg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">.</span><span class="n">size</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nimg</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">stack_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istack</span> <span class="ow">in</span> <span class="n">stack_inds</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;registering &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">istack</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">istack</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">img0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
            <span class="n">sr</span> <span class="o">=</span> <span class="n">StackReg</span><span class="p">(</span><span class="n">StackReg</span><span class="o">.</span><span class="n">TRANSLATION</span><span class="p">)</span>
            <span class="n">tmats</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">register_stack</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s1">&#39;previous&#39;</span><span class="p">)</span>
            <span class="n">nframes</span><span class="o">=</span><span class="n">tmats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">iframe</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nframes</span><span class="p">):</span>
                <span class="n">tmatrix</span><span class="o">=</span><span class="n">tmats</span><span class="p">[</span><span class="n">iframe</span><span class="p">,:,:]</span>
                <span class="c1">#th=np.arctan2(-tmatrix[0,1],tmatrix[0,0])</span>
                <span class="n">tSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">iframe</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> 
                <span class="n">tSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">iframe</span><span class="p">],</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    stack &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">istack</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iframe</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; transx: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">iframe</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; transy: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">iframe</span><span class="p">],</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="o">=</span><span class="n">tSet</span>

    <span class="k">def</span> <span class="nf">get_imageSet_trans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nimg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">.</span><span class="n">size</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nimg</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">stack_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istack</span> <span class="ow">in</span> <span class="n">stack_inds</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;registering &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">istack</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">istack</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mskSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">tSet_stack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stack_trans</span><span class="p">(</span><span class="n">mskSet</span><span class="p">)</span>
            <span class="n">tSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span><span class="o">=</span><span class="n">tSet_stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="o">=</span><span class="n">tSet</span>                            

    <span class="k">def</span> <span class="nf">get_cell_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imgSet&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;no image set: first call get_imageSet(start_frame,end_frame)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">nImg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">totalcells</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">cells_frameSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">cells_imgfileSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">cells_indSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">cells_timeSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">cells_indimgSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="c1">#self.cellblockSet=[None]*nImg</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nImg</span><span class="p">):</span>
            <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">cellblocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_blocks</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="n">ncells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cellblocks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">totalcells</span><span class="o">=</span><span class="n">totalcells</span><span class="o">+</span><span class="n">ncells</span>
            <span class="c1">#self.cellblockSet[im]=cellblocks.copy()</span>
            <span class="n">cells_frameSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells_frameSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
            <span class="n">cells_imgfileSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells_imgfileSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
            <span class="n">cells_indSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells_indSet</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">cells_timeSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells_timeSet</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeSet</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
            <span class="n">cells_indimgSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells_indimgSet</span><span class="p">,</span><span class="n">im</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; file &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; with &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cells</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="o">=</span><span class="n">cells_frameSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="o">=</span><span class="n">cells_imgfileSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">=</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">=</span><span class="n">cells_indimgSet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_timeSet</span><span class="o">=</span><span class="n">cells_timeSet</span>

    <span class="k">def</span> <span class="nf">get_cell_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcells</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">indcells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imgSet_t&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stack has not been trans registered: calling get_imageSet_trans()</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_imageSet_trans</span><span class="p">()</span>
        <span class="n">ncells</span><span class="o">=</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span>
        <span class="n">cells_imgs</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ncells</span>
        <span class="n">cells_msks</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ncells</span>
        <span class="n">cells_positionSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">ip_frame</span><span class="o">=</span><span class="mi">100000</span>
        <span class="n">ip_file</span><span class="o">=</span><span class="mi">100000</span>
        <span class="n">ii</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indcells</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_frame</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;loading cells from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; image &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
                <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
                <span class="c1">#cellblocks=self.cellblockSet[self.cells_frameSet[ic]-start_frame]</span>
                <span class="n">cellblocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_blocks</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="n">imgcell</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
            <span class="n">imgcell</span><span class="o">=</span><span class="n">imgcell</span><span class="p">[:,</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">mskcell</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
            <span class="n">mskcell</span><span class="o">=</span><span class="n">mskcell</span><span class="p">[:,</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1">#icell=np.median(mskcell[np.where(mskcell&gt;0)])</span>
            <span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mskcell</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)],</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">icell</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">mskcell</span><span class="o">=</span><span class="n">mskcell</span><span class="o">==</span><span class="n">icell</span>
            <span class="n">nx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">imgcell</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ny</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">imgcell</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
            <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
            <span class="n">x</span><span class="o">=</span><span class="n">cmskx</span><span class="o">+</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span><span class="o">=</span><span class="n">cmsky</span><span class="o">+</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cells_positionSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells_positionSet</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cells_imgs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cells_msks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">mskcell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ip_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">ip_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">ii</span><span class="o">=</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">cells_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cells_positionSet</span><span class="p">)</span>
        <span class="n">ii</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indcells</span><span class="p">:</span>
            <span class="n">cells_x</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">cells_positionSet</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cells_x</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">cells_positionSet</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ii</span><span class="o">=</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_imgs</span><span class="o">=</span><span class="n">cells_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_msks</span><span class="o">=</span><span class="n">cells_msks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_positionSet</span><span class="o">=</span><span class="n">cells_positionSet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">cells_x</span>

    <span class="k">def</span> <span class="nf">get_cell_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imgSet_t&#39;</span><span class="p">):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;stack has not been trans registered: calling get_imageSet_trans()</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_imageSet_trans</span><span class="p">()</span>
        <span class="n">ncells</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span>
        <span class="n">cells_positionSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">cells_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;loading cells from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; imagestack &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">indc_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">im</span><span class="p">)</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_clean_mask</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="n">centers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">msk</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">msk</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">cells_positionSet</span><span class="p">[</span><span class="n">indc_img</span><span class="p">,:]</span><span class="o">=</span><span class="n">centers</span>
            <span class="n">centers</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">centers</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">centers</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">centers</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cells_x</span><span class="p">[</span><span class="n">indc_img</span><span class="p">,:]</span><span class="o">=</span><span class="n">centers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_positionSet</span><span class="o">=</span><span class="n">cells_positionSet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">cells_x</span>

    <span class="k">def</span> <span class="nf">get_cellborder_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcells</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fmskSet&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_fmaskSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="k">if</span> <span class="n">indcells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ncells</span><span class="o">=</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span>
        <span class="n">cellborder_imgs</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ncells</span>
        <span class="n">cellborder_msks</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ncells</span>
        <span class="n">cellborder_fmsks</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">ncells</span>
        <span class="n">ip_frame</span><span class="o">=</span><span class="mi">100000</span>
        <span class="n">ip_file</span><span class="o">=</span><span class="mi">100000</span>
        <span class="n">ii</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indcells</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">==</span><span class="n">ip_frame</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;extracting cellborders from frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; image &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
                <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
                <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span>
                <span class="c1">#cellblocks=self.cellblockSet[self.cells_frameSet[ic]-start_frame]</span>
                <span class="n">cellblocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_blocks</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="n">xmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">bordersize</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">xmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bordersize</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ymin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">bordersize</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ymax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">bordersize</span><span class="p">,</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">imgcell</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,:]</span>
            <span class="n">imgcell</span><span class="o">=</span><span class="n">imgcell</span><span class="p">[:,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">]</span>
            <span class="n">mskcell</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,:]</span>
            <span class="n">mskcell</span><span class="o">=</span><span class="n">mskcell</span><span class="p">[:,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">]</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">fmsk</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">,:]</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">fmskcell</span><span class="p">[:,</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">]</span>
            <span class="n">tightmskcell</span><span class="o">=</span><span class="n">msk</span><span class="p">[</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
            <span class="n">tightmskcell</span><span class="o">=</span><span class="n">tightmskcell</span><span class="p">[:,</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]:</span><span class="n">cellblocks</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1">#icell=np.median(mskcell[np.where(mskcell&gt;0)])</span>
            <span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tightmskcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tightmskcell</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)],</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">icell</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">mskcell</span><span class="o">=</span><span class="n">mskcell</span><span class="o">==</span><span class="n">icell</span>
            <span class="n">cellborder_imgs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cellborder_msks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">mskcell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cellborder_fmsks</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">=</span><span class="n">fmskcell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ip_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">ip_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">ii</span><span class="o">=</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="o">=</span><span class="n">cellborder_imgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="o">=</span><span class="n">cellborder_msks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellborder_fmsks</span><span class="o">=</span><span class="n">cellborder_fmsks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellborder_inds</span><span class="o">=</span><span class="n">indcells</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_lineage_mindist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">distcut</span><span class="o">=</span><span class="mf">65.0</span><span class="p">,</span><span class="n">pathto</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nimg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">.</span><span class="n">size</span>
        <span class="n">linSet</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nimg</span>
        <span class="n">stack_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">maxdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">mindx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span>
            <span class="n">maxdy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">mindy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fmskSet&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_fmaskSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istack</span> <span class="ow">in</span> <span class="n">stack_inds</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracking &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">istack</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">istack</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">imgSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">mskSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">nframes</span><span class="o">=</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lin0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indt0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">linSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">lin0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nframes</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">img0</span><span class="o">=</span><span class="n">imgSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
                <span class="n">msk0</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
                <span class="n">xt0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:]</span>
                <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">img1</span><span class="o">=</span><span class="n">imgSet</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
                <span class="n">msk1</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
                <span class="n">xt1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]</span>
                <span class="n">dmatx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xt1</span><span class="p">,</span><span class="n">xt0</span><span class="p">)</span>
                <span class="n">lin1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span> <span class="c1">#nn tracking</span>
                    <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dmatx</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                    <span class="n">cdist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                    <span class="k">if</span> <span class="n">cdist</span><span class="o">&lt;</span><span class="n">distcut</span><span class="p">:</span>
                        <span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                <span class="n">linSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">lin1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ulin1</span><span class="p">,</span><span class="n">lin1_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lin1</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    stack &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">istack</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ntracked: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lin1</span><span class="p">[</span><span class="n">indgood</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; twins: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lin1_counts</span><span class="o">==</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; triplets: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lin1_counts</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                    <span class="n">fmsk0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],:,:]</span>
                    <span class="n">fmsk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],:,:]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">fmsk0</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;darkgreen&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">fmsk1</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">msk0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">msk1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">scatter1_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span> <span class="c1">#when you scatter in pts, need (y,x)</span>
                    <span class="n">scatter0_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indgood</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">head_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">mindx</span><span class="p">,</span><span class="n">maxdx</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mindy</span><span class="p">,</span><span class="n">maxdy</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pathto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">imgfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">im</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pathto</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">+</span><span class="s1">&#39;_trackmd_stack&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">istack</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">imgfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="o">=</span><span class="n">linSet</span>

    <span class="k">def</span> <span class="nf">get_lineage_bunch_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">distcut</span><span class="o">=</span><span class="mf">45.0</span><span class="p">,</span><span class="n">distcutb</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span><span class="n">overlapcut</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">cellcut</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="mf">100.</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span><span class="n">pathto</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clustervisual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">maxdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">mindx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span>
            <span class="n">maxdy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">mindy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span>
            <span class="k">if</span> <span class="n">pathto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span><span class="o">=</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">pathto</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;fmskSet&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_fmaskSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_frame</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">end_frame</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">StackReg</span><span class="p">(</span><span class="n">StackReg</span><span class="o">.</span><span class="n">RIGID_BODY</span><span class="p">)</span>
        <span class="n">nimg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">.</span><span class="n">size</span>
        <span class="n">linSet</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">nimg</span>
        <span class="n">stack_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">istack</span> <span class="ow">in</span> <span class="n">stack_inds</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracking &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileList</span><span class="p">[</span><span class="n">istack</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">istack</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">imgSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">mskSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">fmskSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">inds</span><span class="p">,:,:]</span>
            <span class="n">nframes</span><span class="o">=</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lin0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indt0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">linSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">=</span><span class="n">lin0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nframes</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">nx</span><span class="o">=</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
                <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">img0</span><span class="o">=</span><span class="n">imgSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
                <span class="n">msk0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_clean_mask</span><span class="p">(</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:],</span><span class="n">minsize</span><span class="o">=</span><span class="n">cellcut</span><span class="p">)</span>
                <span class="n">fmsk0</span><span class="o">=</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
                <span class="n">bmsk0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk0</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="n">bunchcut</span><span class="p">)</span>
                <span class="n">xt0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:]</span>
                <span class="n">fmsk1</span><span class="o">=</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
                <span class="n">bmsk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk1</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="n">bunchcut</span><span class="p">)</span>
                <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">img1</span><span class="o">=</span><span class="n">imgSet</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span>
                <span class="n">msk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_clean_mask</span><span class="p">(</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:],</span><span class="n">minsize</span><span class="o">=</span><span class="n">cellcut</span><span class="p">)</span>
                <span class="n">xt1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]</span>
                <span class="n">dmatx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xt1</span><span class="p">,</span><span class="n">xt0</span><span class="p">)</span>
                <span class="n">lin1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bmsk1</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bmsk0</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">ind_na</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bunch_clusters0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk0</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],:])</span>
                    <span class="n">xb0</span><span class="o">=</span><span class="n">bunch_clusters0</span><span class="o">.</span><span class="n">clustercenters</span>
                    <span class="n">indb0</span><span class="o">=</span><span class="n">bunch_clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">xt0</span><span class="p">)</span>
                    <span class="n">bunch_clusters1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk1</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],:])</span>
                    <span class="n">indb1</span><span class="o">=</span><span class="n">bunch_clusters1</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">xt1</span><span class="p">)</span>
                    <span class="n">xb1</span><span class="o">=</span><span class="n">bunch_clusters1</span><span class="o">.</span><span class="n">clustercenters</span>
                    <span class="n">dmatxb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xb1</span><span class="p">,</span><span class="n">xb0</span><span class="p">)</span>
                    <span class="n">lin1b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xb1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xb1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1">#nn tracking</span>
                        <span class="n">ind_nnxb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dmatxb</span><span class="p">[</span><span class="n">ib</span><span class="p">,:])</span>
                        <span class="n">bdist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">xb0</span><span class="p">[</span><span class="n">ind_nnxb</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span><span class="n">xb1</span><span class="p">[</span><span class="n">ib</span><span class="p">,:])</span>
                        <span class="k">if</span> <span class="n">bdist</span><span class="o">&lt;</span><span class="n">distcutb</span><span class="p">:</span>
                            <span class="n">lin1b</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span><span class="o">=</span><span class="n">ind_nnxb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lin1b</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                    <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1b</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">clustervisual</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">bmsk0</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bmsk0</span><span class="p">)),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greens</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">bmsk1</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bmsk1</span><span class="p">)),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Reds</span><span class="p">)</span>
                        <span class="n">contour0_img</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">msk0</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk0</span><span class="p">)),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">contour1_img</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">msk1</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk1</span><span class="p">)),</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">scatter1_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xb1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xb1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="c1">#when you scatter in pts, need (y,x)</span>
                        <span class="n">scatter0_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xb0</span><span class="p">[</span><span class="n">lin1b</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xb0</span><span class="p">[</span><span class="n">lin1b</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="n">indgood</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xb0</span><span class="p">[</span><span class="n">lin1b</span><span class="p">[</span><span class="n">ib</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xb1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xb0</span><span class="p">[</span><span class="n">lin1b</span><span class="p">[</span><span class="n">ib</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">xb1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cellblocks0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_blocks</span><span class="p">(</span><span class="n">bmsk0</span><span class="p">)</span>
                    <span class="n">cellblocks0</span><span class="o">=</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">lin1b</span><span class="p">[</span><span class="n">indgood</span><span class="p">],:,:]</span>
                    <span class="n">cellblocks1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_blocks</span><span class="p">(</span><span class="n">bmsk1</span><span class="p">)</span>
                    <span class="n">cellblocks1</span><span class="o">=</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,:,:]</span>
                    <span class="n">cell_clusters0</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">AssignCenters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_positionSet</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">cell_clusters1</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">AssignCenters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_positionSet</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">inds_c1b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cellblocks1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">minx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]));</span> <span class="n">miny</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]]))</span>
                        <span class="n">maxx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]));</span> <span class="n">maxy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]]))</span>
                        <span class="n">imgb0</span><span class="o">=</span><span class="n">img0</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,:];</span> <span class="n">imgb0</span><span class="o">=</span><span class="n">imgb0</span><span class="p">[:,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
                        <span class="n">imgb1</span><span class="o">=</span><span class="n">img1</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,:];</span> <span class="n">imgb1</span><span class="o">=</span><span class="n">imgb1</span><span class="p">[:,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
                        <span class="n">mskb0</span><span class="o">=</span><span class="n">bmsk0</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,:];</span> <span class="n">mskb0</span><span class="o">=</span><span class="n">mskb0</span><span class="p">[:,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
                        <span class="n">mskb1</span><span class="o">=</span><span class="n">bmsk1</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,:];</span> <span class="n">mskb1</span><span class="o">=</span><span class="n">mskb1</span><span class="p">[:,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
                        <span class="n">mskc0</span><span class="o">=</span><span class="n">msk0</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,:];</span> <span class="n">mskc0</span><span class="o">=</span><span class="n">mskc0</span><span class="p">[:,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
                        <span class="n">mskc1</span><span class="o">=</span><span class="n">msk1</span><span class="p">[</span><span class="n">minx</span><span class="p">:</span><span class="n">maxx</span><span class="p">,:];</span> <span class="n">mskc1</span><span class="o">=</span><span class="n">mskc1</span><span class="p">[:,</span><span class="n">miny</span><span class="p">:</span><span class="n">maxy</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskc0</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskc1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Bunch &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; is empty...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskb0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mskb0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)],</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">ibunch0</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">mskb0</span><span class="o">=</span><span class="n">mskb0</span><span class="o">==</span><span class="n">ibunch0</span>
                            <span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">counts</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskb1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mskb1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)],</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">ibunch1</span><span class="o">=</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">mskb1</span><span class="o">=</span><span class="n">mskb1</span><span class="o">==</span><span class="n">ibunch1</span>
                            <span class="n">imgb0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mskb0</span><span class="p">))]</span><span class="o">=</span><span class="mf">0.0</span>
                            <span class="n">imgb1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mskb1</span><span class="p">))]</span><span class="o">=</span><span class="mf">0.0</span>
                            <span class="n">tmatrix</span><span class="o">=</span><span class="n">sr</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imgb0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imgb1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#from second to first</span>
                            <span class="n">imgb1_reg</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">imgb1</span><span class="p">,</span><span class="n">tmatrix</span><span class="p">)</span>
                            <span class="n">mskb1_reg</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">mskb1</span><span class="p">,</span><span class="n">tmatrix</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#0 for nn interp</span>
                            <span class="n">mskb1_reg</span><span class="o">=</span><span class="n">mskb1_reg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">mskc1_reg</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">mskc1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span><span class="n">tmatrix</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#0 for nn interp</span>
                            <span class="n">mskc1_reg</span><span class="o">=</span><span class="n">mskc1_reg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">indc0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskc0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mskc0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">);</span> <span class="n">indc1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskc1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mskc1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">nx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mskc0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mskc1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">xxc</span><span class="p">,</span><span class="n">yyc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
                            <span class="n">overlap_matrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                            <span class="n">inds_c0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">ic0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                <span class="n">mskic0</span><span class="o">=</span><span class="n">mskc0</span><span class="o">==</span><span class="n">indc0</span><span class="p">[</span><span class="n">ic0</span><span class="p">]</span>
                                <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span><span class="n">mskic0</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskic0</span><span class="p">)</span>
                                <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yyc</span><span class="p">,</span><span class="n">mskic0</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskic0</span><span class="p">)</span>
                                <span class="n">xc0</span><span class="o">=</span><span class="n">cmskx</span><span class="o">+</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">yc0</span><span class="o">=</span><span class="n">cmsky</span><span class="o">+</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">x0</span><span class="p">[</span><span class="n">ic0</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xc0</span><span class="o">-</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">yc0</span><span class="o">-</span><span class="n">cellblocks0</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
                                <span class="n">inds_c0</span><span class="p">[</span><span class="n">ic0</span><span class="p">]</span><span class="o">=</span><span class="n">cell_clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xc0</span><span class="p">,</span><span class="n">yc0</span><span class="p">]]))[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">inds_c1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                            <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">ic1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                <span class="n">mskic1</span><span class="o">=</span><span class="n">mskc1_reg</span><span class="o">==</span><span class="n">indc1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span>
                                <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span><span class="n">mskic1</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskic1</span><span class="p">)</span>
                                <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yyc</span><span class="p">,</span><span class="n">mskic1</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskic1</span><span class="p">)</span>
                                <span class="n">xc1</span><span class="o">=</span><span class="n">cmskx</span><span class="o">+</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">yc1</span><span class="o">=</span><span class="n">cmsky</span><span class="o">+</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span> <span class="n">x1</span><span class="p">[</span><span class="n">ic1</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xc1</span><span class="o">-</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">yc1</span><span class="o">-</span><span class="n">cellblocks1</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
                                <span class="n">inds_c1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span><span class="o">=</span><span class="n">cell_clusters1</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xc1</span><span class="p">,</span><span class="n">yc1</span><span class="p">]]))[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">inds_c1b</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_c1b</span><span class="p">,</span><span class="n">inds_c1</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">ic0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span><span class="p">):</span> <span class="c1">#get overlap matrix</span>
                                <span class="n">mskic0</span><span class="o">=</span><span class="n">mskc0</span><span class="o">==</span><span class="n">indc0</span><span class="p">[</span><span class="n">ic0</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">ic1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                    <span class="n">mskic1</span><span class="o">=</span><span class="n">mskc1_reg</span><span class="o">==</span><span class="n">indc1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span>
                                    <span class="n">overlap_matrix</span><span class="p">[</span><span class="n">ic0</span><span class="p">,</span><span class="n">ic1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">mskic0</span><span class="p">,</span><span class="n">mskic1</span><span class="p">))</span>
                            <span class="n">linb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>
                            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indc1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span> <span class="c1">#pick max overlap</span>
                                <span class="n">ind_nn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">overlap_matrix</span><span class="p">[:,</span><span class="n">ic</span><span class="p">])</span>
                                <span class="n">cpix</span><span class="o">=</span><span class="n">overlap_matrix</span><span class="p">[</span><span class="n">ind_nn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ic</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">cpix</span><span class="o">&gt;</span><span class="n">overlapcut</span><span class="p">:</span>
                                    <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dmatx</span><span class="p">[</span><span class="n">inds_c1</span><span class="p">[</span><span class="n">ic</span><span class="p">],:])</span>
                                    <span class="n">cdist</span><span class="o">=</span><span class="n">dmatx</span><span class="p">[</span><span class="n">inds_c1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="k">if</span> <span class="n">cdist</span><span class="o">&lt;</span><span class="n">distcut</span><span class="p">:</span>
                                        <span class="n">lin1</span><span class="p">[</span><span class="n">inds_c1</span><span class="p">[</span><span class="n">ic</span><span class="p">]]</span><span class="o">=</span><span class="n">inds_c0</span><span class="p">[</span><span class="n">ind_nn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                                        <span class="n">linb</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">ind_nn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">clustervisual</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span><span class="n">yyc</span><span class="p">,</span><span class="n">mskb0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span><span class="n">yyc</span><span class="p">,</span><span class="n">mskb1_reg</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span><span class="n">yyc</span><span class="p">,</span><span class="n">mskc0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskc0</span><span class="p">));</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xxc</span><span class="p">,</span><span class="n">yyc</span><span class="p">,</span><span class="n">mskc1_reg</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mskc1</span><span class="p">))</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cluster &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ib</span><span class="p">))</span>
                                <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">linb</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indgood</span><span class="p">:</span>
                                    <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="n">linb</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">x0</span><span class="p">[</span><span class="n">linb</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">x1</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="n">linb</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">x1</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="n">linb</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">head_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.3</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ic1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span> <span class="c1">#trim too long tracks in global basis</span>
                        <span class="n">ic0</span><span class="o">=</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">ic0</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">distc</span><span class="o">=</span><span class="n">dmatx</span><span class="p">[</span><span class="n">ic1</span><span class="p">,</span><span class="n">ic0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">distc</span><span class="o">&gt;</span><span class="n">distcut</span><span class="p">:</span>
                                <span class="n">lin1</span><span class="p">[</span><span class="n">ic1</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                    <span class="n">ind_na</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">comm</span><span class="p">,</span><span class="n">indcomm1</span><span class="p">,</span><span class="n">indcomm2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind_na</span><span class="p">,</span><span class="n">inds_c1b</span><span class="p">,</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ind_na</span><span class="p">[</span><span class="n">indcomm1</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                    <span class="n">ind_na</span><span class="o">=</span><span class="n">ind_na</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ind_na</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">ind_na</span><span class="p">:</span> <span class="c1">#nn tracking for cells not in bunches</span>
                    <span class="k">if</span> <span class="n">xt0</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dmatx</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                        <span class="n">cdist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                        <span class="k">if</span> <span class="n">cdist</span><span class="o">&lt;</span><span class="n">distcut</span><span class="p">:</span>
                            <span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">lin1</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">indtracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">ulin1</span><span class="p">,</span><span class="n">lin1_counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lin1</span><span class="p">[</span><span class="n">indtracked</span><span class="p">],</span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    stack &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">istack</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ntracked: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lin1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span> <span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indt1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; twins: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lin1_counts</span><span class="o">==</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; triplets before cleaning: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lin1_counts</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;    stack &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">istack</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; frame &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ntracked: 0 of 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ind_oa</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1_counts</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#clean triplets and up</span>
                <span class="k">for</span> <span class="n">ioa</span> <span class="ow">in</span> <span class="n">ind_oa</span><span class="p">:</span>
                    <span class="n">ic0</span><span class="o">=</span><span class="n">ulin1</span><span class="p">[</span><span class="n">ioa</span><span class="p">]</span>
                    <span class="n">indc1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1</span><span class="o">==</span><span class="n">ic0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">distc1</span><span class="o">=</span><span class="n">dmatx</span><span class="p">[</span><span class="n">indc1</span><span class="p">,</span><span class="n">ic0</span><span class="p">]</span>
                    <span class="n">ind_nnx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">distc1</span><span class="p">)</span>
                    <span class="n">ind_out</span><span class="o">=</span><span class="n">indc1</span><span class="p">[</span><span class="n">ind_nnx</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]</span>
                    <span class="n">lin1</span><span class="p">[</span><span class="n">ind_out</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">fmsk0</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;darkgreen&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">fmsk1</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">msk0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">msk1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">],</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lin1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">scatter1_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">indgood</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span> <span class="c1">#when you scatter in pts, need (y,x)</span>
                    <span class="n">scatter0_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">indgood</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indgood</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xt0</span><span class="p">[</span><span class="n">lin1</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">head_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">mindx</span><span class="p">,</span><span class="n">maxdx</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mindy</span><span class="p">,</span><span class="n">maxdy</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pathto</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">imgfile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">im</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pathto</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">+</span><span class="s1">&#39;_trackbo_stack&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">istack</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">imgfile</span><span class="p">)</span>
                <span class="n">linSet</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">=</span><span class="n">lin1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="o">=</span><span class="n">linSet</span>

    <span class="k">def</span> <span class="nf">get_cell_boundary_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcell</span><span class="p">,</span><span class="n">msk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cpix</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="p">[</span><span class="n">indcell</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">msk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet_cyto</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">indcell</span><span class="p">],:,:]</span>
        <span class="n">mskc</span><span class="o">=</span><span class="n">msk</span><span class="o">==</span><span class="n">ic</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">boundarysize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mahotas</span><span class="o">.</span><span class="n">borders</span><span class="p">(</span><span class="n">mskc</span><span class="p">,</span><span class="n">Bc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">cpix</span><span class="p">,</span><span class="n">cpix</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">boundarysize</span>

    <span class="k">def</span> <span class="nf">get_cell_neighborhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rcut</span><span class="o">=</span><span class="mf">200.</span><span class="p">,</span><span class="n">visual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">cpix</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span> <span class="c1">#returns indices of interacting partners and shared boundary lengths</span>
        <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">indcell</span><span class="p">]</span>
        <span class="n">indt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indt</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indcell</span><span class="p">,:]</span>
        <span class="n">x_img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]</span>
        <span class="n">dist1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x_img</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ind1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist1</span><span class="o">==</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inds_not1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">indt</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span><span class="n">ind1</span><span class="p">)</span>
        <span class="n">dist1</span><span class="o">=</span><span class="n">dist1</span><span class="p">[</span><span class="n">inds_not1</span><span class="p">]</span>
        <span class="n">indsr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist1</span><span class="o">&lt;</span><span class="n">rcut</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_img</span><span class="o">=</span><span class="n">x_img</span><span class="p">[</span><span class="n">inds_not1</span><span class="p">[</span><span class="n">indsr</span><span class="p">],:]</span>
        <span class="n">indt</span><span class="o">=</span><span class="n">indt</span><span class="p">[</span><span class="n">inds_not1</span><span class="p">[</span><span class="n">indsr</span><span class="p">]]</span>
        <span class="n">clabels</span><span class="o">=</span><span class="n">clabels</span><span class="p">[</span><span class="n">inds_not1</span><span class="p">[</span><span class="n">indsr</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">bmsk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
            <span class="n">bmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bunch_clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bunch_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,:])</span>
        <span class="n">indsb</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x_img</span><span class="p">)</span>
        <span class="n">indb1</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inds_b1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indsb</span><span class="o">==</span><span class="n">indb1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_img</span><span class="o">=</span><span class="n">x_img</span><span class="p">[</span><span class="n">inds_b1</span><span class="p">,:]</span><span class="o">-</span><span class="n">x1</span>
        <span class="n">x_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x_img</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">indt</span><span class="o">=</span><span class="n">indt</span><span class="p">[</span><span class="n">inds_b1</span><span class="p">]</span>
        <span class="n">clabels</span><span class="o">=</span><span class="n">clabels</span><span class="p">[</span><span class="n">inds_b1</span><span class="p">]</span>
        <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet_cyto</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">intersurfaces</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">clabels</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clabels</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">intersurfaces</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mahotas</span><span class="o">.</span><span class="n">border</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">ind1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">clabels</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="n">Bc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">cpix</span><span class="p">,</span><span class="n">cpix</span><span class="p">))))</span>
        <span class="n">inds_contact</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">intersurfaces</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intersurfaces</span><span class="o">=</span><span class="n">intersurfaces</span><span class="p">[</span><span class="n">inds_contact</span><span class="p">]</span>
        <span class="n">intersurfaces</span><span class="o">=</span><span class="n">intersurfaces</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">)</span>
        <span class="n">indcells</span><span class="o">=</span><span class="n">indt</span><span class="p">[</span><span class="n">inds_contact</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">visual</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_cellborder_images</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">indcells</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">indcell</span><span class="p">),</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
            <span class="n">nrows</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">xset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">indcells</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">indcell</span><span class="p">)]</span> <span class="c1">#-self.imgSet_t[self.cells_indimgSet[indcell]][1:]</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="n">ic</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                <span class="n">imcenter</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">imcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
                <span class="n">imcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
                <span class="n">T_im</span><span class="o">=</span><span class="n">xset</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span><span class="o">-</span><span class="n">imcenter</span>
                <span class="n">xset1_im</span><span class="o">=</span><span class="n">xset</span><span class="o">-</span><span class="n">T_im</span>
                <span class="n">xset0_im</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xset1_im</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ic2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">i1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">indcells</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">indcell</span><span class="p">)[</span><span class="n">ic2</span><span class="p">]</span>
                    <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">xset0_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span><span class="o">-</span><span class="n">T_im</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xset1_im</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xset1_im</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ic2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">xset1_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xset1_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">xset1_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">xset0_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xset1_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xset0_im</span><span class="p">[</span><span class="n">ic2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">head_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xset1_im</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xset1_im</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">0</span><span class="p">]]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xset1_im</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">xset1_im</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ic</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">comdx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_comdx</span><span class="p">(</span><span class="n">indcell</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;labeled: dx: </span><span class="si">{:2.2}</span><span class="s1"> alpha: </span><span class="si">{:2.2}</span><span class="s1"> beta: </span><span class="si">{:2.2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comdx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">comdx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">comdx</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">indcells</span><span class="p">[</span><span class="n">ic</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">beta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_beta</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">indcells</span><span class="p">[</span><span class="n">ic</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;contact </span><span class="si">{:2.2}</span><span class="s1">, alpha </span><span class="si">{:2.2}</span><span class="s1">, beta </span><span class="si">{:2.2}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">[</span><span class="n">ic</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">),</span><span class="n">alpha</span><span class="p">,</span><span class="n">beta</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indcells</span><span class="p">,</span><span class="n">intersurfaces</span>

    <span class="k">def</span> <span class="nf">get_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ip2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="n">dx1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx1</span><span class="p">)</span>
            <span class="n">dx2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i2</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip2</span><span class="p">,:]</span>
            <span class="n">dx2</span><span class="o">=</span><span class="n">dx2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx2</span><span class="p">)</span>
            <span class="n">pij</span><span class="o">=</span><span class="n">dx1</span><span class="o">-</span><span class="n">dx2</span>
            <span class="n">rij</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i2</span><span class="p">,:])</span>
            <span class="n">nij</span><span class="o">=</span><span class="n">rij</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rij</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pij</span><span class="p">,</span><span class="n">nij</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">get_beta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ip2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="n">dx1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx1</span><span class="p">)</span>
            <span class="n">dx2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i2</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip2</span><span class="p">,:]</span>
            <span class="n">dx2</span><span class="o">=</span><span class="n">dx2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx2</span><span class="p">)</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dx1</span><span class="p">,</span><span class="n">dx2</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">beta</span>

    <span class="k">def</span> <span class="nf">get_dx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i1</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dx1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">ip1</span><span class="p">,:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">dx1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">dx1</span>

    <span class="k">def</span> <span class="nf">feat_comdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">intersurfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_neighborhood</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="n">bmsk</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="p">)</span>
            <span class="n">alphaSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">betaSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">indcells</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">alphaSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_alpha</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">indcells</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
                <span class="n">betaSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_beta</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">indcells</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
            <span class="n">intersurfaces</span><span class="o">=</span><span class="n">intersurfaces</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">)</span>
            <span class="n">comdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">comdx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dx</span><span class="p">(</span><span class="n">indcell</span><span class="p">))</span>
            <span class="n">comdx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">,</span><span class="n">alphaSet</span><span class="p">))</span>
            <span class="n">comdx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">intersurfaces</span><span class="p">,</span><span class="n">betaSet</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">comdx</span>

    <span class="k">def</span> <span class="nf">get_comdx_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nfeat_com</span><span class="o">=</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Xf_com</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nfeat_com</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">traj_pairSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
            <span class="n">bmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">bunch_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,:])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;extracting motility features from image &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">im</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indimgs</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cell_inds_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_cindimg</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">cell_inds_img</span><span class="p">],</span><span class="n">traj_pairSet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indcomm_ctraj</span><span class="p">:</span>
                <span class="n">indcell</span><span class="o">=</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">comdx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feat_comdx</span><span class="p">(</span><span class="n">indcell</span><span class="p">,</span><span class="n">bmsk</span><span class="o">=</span><span class="n">bmsk</span><span class="p">,</span><span class="n">bunch_clusters</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="p">)</span>
                <span class="n">Xf_com</span><span class="p">[</span><span class="n">indcell</span><span class="p">,:]</span><span class="o">=</span><span class="n">comdx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xf_com</span><span class="o">=</span><span class="n">Xf_com</span>

    <span class="k">def</span> <span class="nf">get_cell_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_ind</span><span class="p">,</span><span class="n">n_hist</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#cell trajectory stepping backwards</span>
        <span class="n">ind_imgfile</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgfileSet</span><span class="p">[</span><span class="n">cell_ind</span><span class="p">]])</span>
        <span class="n">minframe</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">ind_imgfile</span><span class="p">)]))</span>
        <span class="k">if</span> <span class="n">n_hist</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_hist</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">cell_ind</span><span class="p">]</span><span class="o">-</span><span class="n">minframe</span><span class="p">)</span>
        <span class="n">cell_ind_history</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_hist</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cell_ind_history</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">cell_ind_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">cell_ind</span>
        <span class="n">ended</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">iH</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_hist</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">indCurrentCell</span><span class="o">=</span><span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ended</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indCurrentCell</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">indCurrentCell</span><span class="p">)</span>
                <span class="n">iframe1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_frameSet</span><span class="p">[</span><span class="n">indCurrentCell</span><span class="p">]</span>
                <span class="n">iframe0</span><span class="o">=</span><span class="n">iframe1</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">indimg1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">ind_imgfile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="o">==</span><span class="n">iframe1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">indimg0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imgfileSet</span><span class="o">==</span><span class="n">ind_imgfile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">frameSet</span><span class="o">==</span><span class="n">iframe0</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">indCurrentCell</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ended</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indCurrentCell</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ended last frame: History must end NOW!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">ended</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">elif</span> <span class="n">indCurrentCell</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ended</span><span class="p">:</span>
                    <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">indimg1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">i1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indt1</span><span class="o">==</span><span class="n">indCurrentCell</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">indimg0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">indtrack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="p">[</span><span class="n">indimg1</span><span class="p">][</span><span class="n">i1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">indtrack</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1">#sys.stdout.write(&#39;            cell &#39;+str(indCurrentCell)+&#39; ended &#39;+str(iH)+&#39; frames ago\n&#39;)</span>
                        <span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">ended</span><span class="o">=</span><span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell_ind_history</span><span class="p">[</span><span class="n">iH</span><span class="p">]</span><span class="o">=</span><span class="n">indt0</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">linSet</span><span class="p">[</span><span class="n">indimg1</span><span class="p">][</span><span class="n">i1</span><span class="p">]]</span>
        <span class="n">indtracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cell_ind_history</span><span class="p">)))</span>
        <span class="n">cell_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">cell_ind_history</span><span class="p">[</span><span class="n">indtracked</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cell_traj</span>

    <span class="k">def</span> <span class="nf">get_all_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">cell_inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n_untracked</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nc0</span><span class="o">=</span><span class="n">n_untracked</span>
        <span class="n">trajectories</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">while</span> <span class="n">n_untracked</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">indc</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span>
            <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_traj</span><span class="p">)</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_call</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds_all</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cell_inds_all</span><span class="p">[</span><span class="n">indcomm_call</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
            <span class="n">inds_untracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cell_inds_all</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="p">[</span><span class="n">inds_untracked</span><span class="p">]</span>
            <span class="n">n_untracked</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">n_untracked</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracked cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracks, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_untracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; left</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">=</span><span class="n">trajectories</span>

    <span class="k">def</span> <span class="nf">get_unique_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">extra_depth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extra_depth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;trajl&#39;</span><span class="p">):</span>
                <span class="n">extra_depth</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extra_depth</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">cell_inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n_untracked</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="o">.</span><span class="n">size</span> 
        <span class="n">trajectories</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">inds_tracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">n_untracked</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">indc</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_trajectory</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span>
            <span class="n">indctracked</span><span class="p">,</span><span class="n">indcomm_tracked</span><span class="p">,</span><span class="n">indcomm_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">inds_tracked</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">indctracked</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">indcomm_last</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indcomm_traj</span><span class="p">)</span>
                <span class="c1">#sys.stdout.write(&#39;cell &#39;+str(indc)+&#39; tracks to &#39;+str(cell_traj[indcomm_last])+&#39;, already tracked\n&#39;)</span>
                <span class="k">if</span> <span class="n">indcomm_last</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">extra_depth</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">indlast</span><span class="o">=</span><span class="n">indcomm_last</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">extra_depth</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indlast</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">cell_traj</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">indlast</span><span class="p">:]</span> <span class="c1">#retain only unique tracks up to extra_depth from common point</span>
            <span class="n">inds_tracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_tracked</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">)</span>
            <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_traj</span><span class="p">)</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_call</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds_all</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cell_inds_all</span><span class="p">[</span><span class="n">indcomm_call</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
            <span class="n">inds_untracked</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cell_inds_all</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cell_inds_all</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="p">[</span><span class="n">inds_untracked</span><span class="p">]</span>
            <span class="n">n_untracked</span><span class="o">=</span><span class="n">cell_inds_all</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracked cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracks, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_untracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; left</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_untracked</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracked cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; tracks, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_untracked</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; left</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="o">=</span><span class="n">trajectories</span>

    <span class="k">def</span> <span class="nf">get_dx_tcf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trajectories</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trajectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trajectories</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span>
        <span class="n">traj_lengths</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntraj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">traj_lengths</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">=</span><span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nframes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_lengths</span><span class="p">)</span>
        <span class="n">nt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">nframes</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dxcorr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">tnorm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span>
            <span class="n">traj_len</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="n">nmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">traj_len</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">traj_len</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">dxtraj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">[</span><span class="mi">1</span><span class="p">:],:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],:]</span>
                <span class="k">for</span> <span class="n">it1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">it2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">it1</span><span class="p">,</span><span class="n">it1</span><span class="o">+</span><span class="n">nmax</span><span class="p">):</span>
                        <span class="n">it</span><span class="o">=</span><span class="n">it2</span><span class="o">-</span><span class="n">it1</span>
                        <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dxtraj</span><span class="p">[</span><span class="n">it1</span><span class="p">,:],</span><span class="n">dxtraj</span><span class="p">[</span><span class="n">it2</span><span class="p">,:])</span>
                        <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">/</span><span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dxcorr</span>

    <span class="k">def</span> <span class="nf">get_xtraj_tcf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectories</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trajectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trajectories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span>
        <span class="n">ntraj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span>
        <span class="n">traj_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntraj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">traj_lengths</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_lengths</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">nframes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dxcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">tnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">cell_traj</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span>
            <span class="n">traj_len</span> <span class="o">=</span> <span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="n">nmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">traj_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">traj_len</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="p">:</span>
                <span class="n">xtraj</span><span class="p">,</span><span class="n">indstraj</span> <span class="o">=</span> <span class="n">get_Xtraj_celltrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">)</span>
                <span class="n">nmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xtraj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">it1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">it2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">it1</span><span class="p">,</span> <span class="n">it1</span> <span class="o">+</span> <span class="n">nmax</span><span class="p">):</span>
                        <span class="n">it</span> <span class="o">=</span> <span class="n">it2</span> <span class="o">-</span> <span class="n">it1</span>
                        <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xtraj</span><span class="p">[</span><span class="n">it1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">xtraj</span><span class="p">[</span><span class="n">it2</span><span class="p">,</span> <span class="p">:])</span>
                        <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">/</span> <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dxcorr</span>

    <span class="k">def</span> <span class="nf">get_tcf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectories</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span>
        <span class="k">if</span> <span class="n">trajectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trajectories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span>
        <span class="n">ntraj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span>
        <span class="n">traj_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ntraj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">traj_lengths</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traj_lengths</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">nframes</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dxcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">tnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">cell_traj</span> <span class="o">=</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span>
            <span class="n">traj_len</span> <span class="o">=</span> <span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="n">nmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">traj_len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">traj_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">xtraj</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">,:]</span>
                <span class="k">for</span> <span class="n">it1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">it2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">it1</span><span class="p">,</span> <span class="n">it1</span> <span class="o">+</span> <span class="n">nmax</span><span class="p">):</span>
                        <span class="n">it</span> <span class="o">=</span> <span class="n">it2</span> <span class="o">-</span> <span class="n">it1</span>
                        <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xtraj</span><span class="p">[</span><span class="n">it1</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">xtraj</span><span class="p">[</span><span class="n">it2</span><span class="p">,</span> <span class="p">:],</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxcorr</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">/</span> <span class="n">tnorm</span><span class="p">[</span><span class="n">it</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dxcorr</span>

    <span class="k">def</span> <span class="nf">get_pair_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_indsA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cell_indsB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nr</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">rmax</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_indsA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_indsA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell_indsB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_indsB</span><span class="o">=</span><span class="n">cell_indsA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">rmax</span><span class="p">,</span><span class="n">nr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1.e-8</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indimgsA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">])</span>
        <span class="n">indimgsB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">])</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">indimgsA</span><span class="p">,</span><span class="n">indimgsB</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">cell_inds_imgA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cell_inds_imgB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xSetA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">[</span><span class="n">cell_inds_imgA</span><span class="p">],:]</span>
            <span class="n">xSetB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">[</span><span class="n">cell_inds_imgB</span><span class="p">],:]</span>
            <span class="n">dmatr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xSetA</span><span class="p">,</span><span class="n">xSetB</span><span class="p">)</span>
            <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">dmatr</span><span class="p">,</span><span class="n">rbins</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nr</span><span class="p">):</span>
                <span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indr</span><span class="o">==</span><span class="n">ir</span><span class="p">)</span>
        <span class="n">drbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">paircorrx</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">nc</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">norm</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">rbins</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">*</span><span class="n">drbins</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span>
            <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="o">+</span><span class="n">norm</span>
            <span class="n">nc</span><span class="o">=</span><span class="n">nc</span><span class="o">+</span><span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span>
            <span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">paircorrx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">paircorrx</span><span class="o">*</span><span class="n">V</span><span class="o">/</span><span class="n">nc</span>
        <span class="k">return</span> <span class="n">rbins</span><span class="p">,</span><span class="n">paircorrx</span>

    <span class="k">def</span> <span class="nf">get_pair_cluster_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_indsA</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cell_indsB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nr</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">rmax</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_indsA</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_indsA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell_indsB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_indsB</span><span class="o">=</span><span class="n">cell_indsA</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.e-6</span><span class="p">,</span><span class="n">rmax</span><span class="p">,</span><span class="n">nr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1.e-8</span>
        <span class="n">allcellsr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">clustercellsr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">indimgsA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">])</span>
        <span class="n">indimgsB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">])</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">indimgsA</span><span class="p">,</span><span class="n">indimgsB</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fmskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
            <span class="n">bmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">bunch_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,:])</span>
            <span class="n">cell_inds_imgA</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cell_inds_imgB</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xSetA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_indsA</span><span class="p">[</span><span class="n">cell_inds_imgA</span><span class="p">],:]</span>
            <span class="n">xSetB</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_indsB</span><span class="p">[</span><span class="n">cell_inds_imgB</span><span class="p">],:]</span>
            <span class="n">bSetA</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">xSetA</span><span class="p">)</span>
            <span class="n">bSetB</span><span class="o">=</span><span class="n">bunch_clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">xSetB</span><span class="p">)</span>
            <span class="n">dmatr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xSetA</span><span class="p">,</span><span class="n">xSetB</span><span class="p">)</span>
            <span class="n">indnotb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">bSetA</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">bSetB</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dmatrb</span><span class="o">=</span><span class="n">dmatr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dmatrb</span><span class="p">[</span><span class="n">indnotb</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">dmatr</span><span class="p">,</span><span class="n">rbins</span><span class="p">)</span>
            <span class="n">indrb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">dmatrb</span><span class="p">,</span><span class="n">rbins</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nr</span><span class="p">):</span>
                <span class="n">allcellsr</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">allcellsr</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indr</span><span class="o">==</span><span class="n">ir</span><span class="p">)</span>
                <span class="n">clustercellsr</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">clustercellsr</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indrb</span><span class="o">==</span><span class="n">ir</span><span class="p">)</span>
        <span class="n">drbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">rbins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">paircorrx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">clustercellsr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">allcellsr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rbins</span><span class="p">,</span><span class="n">paircorrx</span>

    <span class="k">def</span> <span class="nf">get_dx_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nr</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">rmax</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rmax</span><span class="p">,</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">nr</span><span class="o">=</span><span class="n">rbins</span><span class="o">.</span><span class="n">size</span>
        <span class="n">traj_pairSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">paircorrdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">cell_inds_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_cindimg</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">cell_inds_img</span><span class="p">],</span><span class="n">traj_pairSet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">dxSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">dmatr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xSet</span><span class="p">)</span>
            <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">dmatr</span><span class="p">,</span><span class="n">rbins</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nr</span><span class="p">):</span>
                <span class="n">indcells_dr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indr</span><span class="o">==</span><span class="n">ir</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">paircorrdx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">paircorrdx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dxSet</span><span class="p">[</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">],</span><span class="n">dxSet</span><span class="p">[</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dxSet</span><span class="p">[</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">],</span><span class="n">dxSet</span><span class="p">[</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                    <span class="n">norm</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">norm</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">rbins</span><span class="o">=</span><span class="n">rbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">paircorrdx</span><span class="o">=</span><span class="n">paircorrdx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">paircorrdx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">paircorrdx</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rbins</span><span class="p">,</span><span class="n">paircorrdx</span>

    <span class="k">def</span> <span class="nf">get_dx_theta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rcut</span><span class="o">=</span><span class="mf">100.</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nth</span><span class="p">)</span>
        <span class="n">nth</span><span class="o">=</span><span class="n">thbins</span><span class="o">.</span><span class="n">size</span>
        <span class="n">traj_pairSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">paircosth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nth</span><span class="p">)</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">cell_inds_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_cindimg</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">cell_inds_img</span><span class="p">],</span><span class="n">traj_pairSet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">dxSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">dxSetn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dxSet</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dxSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dxSet</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="mi">2</span><span class="p">)))</span>
                <span class="n">dxSetn</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">dxSet</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="n">n</span>
            <span class="n">dmatr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xSet</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dmatr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">dmatr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1">#don&#39;t count self-self, only keep lower diag</span>
            <span class="n">indcells_dr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dmatr</span><span class="o">&lt;</span><span class="n">rcut</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">dxc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dxSetn</span><span class="p">[</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span><span class="n">dxSetn</span><span class="p">[</span><span class="n">indcells_dr</span><span class="p">[</span><span class="mi">1</span><span class="p">],:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">indth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">dxc</span><span class="p">,</span><span class="n">thbins</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ith</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nth</span><span class="p">):</span>
                    <span class="n">nc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indth</span><span class="o">==</span><span class="n">ith</span><span class="p">)</span>
                    <span class="n">paircosth</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span><span class="o">=</span><span class="n">paircosth</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span><span class="o">+</span><span class="n">nc</span>
        <span class="n">paircosth</span><span class="o">=</span><span class="n">paircosth</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">thbins</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">thbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">thbins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">paircosth</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paircosth</span><span class="p">))]</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">paircosth</span><span class="o">=</span><span class="n">paircosth</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">paircosth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thbins</span><span class="p">,</span><span class="n">paircosth</span>

    <span class="k">def</span> <span class="nf">get_dx_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">thbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">rcut</span><span class="o">=</span><span class="mf">40.</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cell_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">thbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span><span class="mf">2.</span><span class="p">,</span><span class="n">nth</span><span class="p">)</span>
        <span class="n">nth</span><span class="o">=</span><span class="n">thbins</span><span class="o">.</span><span class="n">size</span>
        <span class="n">traj_pairSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">paircosth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nth</span><span class="p">)</span> <span class="c1">#note not really cosine of an angle!!</span>
        <span class="n">indimgs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">indimgs</span><span class="p">:</span>
            <span class="n">cell_inds_img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_inds</span><span class="p">]</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">indcells</span><span class="p">,</span><span class="n">indcomm_cindimg</span><span class="p">,</span><span class="n">indcomm_ctraj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">cell_inds_img</span><span class="p">],</span><span class="n">traj_pairSet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">dxSet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">1</span><span class="p">],:]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">traj_pairSet</span><span class="p">[</span><span class="n">indcomm_ctraj</span><span class="p">,</span><span class="mi">0</span><span class="p">],:]</span>
            <span class="n">dxSetn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dxSet</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dxSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">n</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dxSet</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span><span class="mi">2</span><span class="p">)))</span>
                <span class="n">dxSetn</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">dxSet</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="n">n</span>
            <span class="n">dmatr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xSet</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dmatr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">dmatr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1">#don&#39;t count self-self, only keep lower diag</span>
            <span class="n">indcells_dr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dmatr</span><span class="o">&lt;</span><span class="n">rcut</span><span class="p">)</span>
            <span class="n">alphaSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="n">indcells_dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="n">indcells_dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">pij</span><span class="o">=</span><span class="n">dxSetn</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="n">dxSetn</span><span class="p">[</span><span class="n">i2</span><span class="p">,:]</span>
                        <span class="n">rij</span><span class="o">=</span><span class="p">(</span><span class="n">xSet</span><span class="p">[</span><span class="n">i1</span><span class="p">,:]</span><span class="o">-</span><span class="n">xSet</span><span class="p">[</span><span class="n">i2</span><span class="p">,:])</span>
                        <span class="n">nij</span><span class="o">=</span><span class="n">rij</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rij</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">pij</span><span class="p">,</span><span class="n">nij</span><span class="p">))</span>
                        <span class="n">alphaSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alphaSet</span><span class="p">,</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">indth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">alphaSet</span><span class="p">,</span><span class="n">thbins</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ith</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nth</span><span class="p">):</span>
                    <span class="n">nc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indth</span><span class="o">==</span><span class="n">ith</span><span class="p">)</span>
                    <span class="n">paircosth</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span><span class="o">=</span><span class="n">paircosth</span><span class="p">[</span><span class="n">ith</span><span class="p">]</span><span class="o">+</span><span class="n">nc</span>
        <span class="n">paircosth</span><span class="o">=</span><span class="n">paircosth</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">thbins</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">thbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">thbins</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">paircosth</span><span class="o">=</span><span class="n">paircosth</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">paircosth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">thbins</span><span class="p">,</span><span class="n">paircosth</span>

    <span class="k">def</span> <span class="nf">get_traj_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">seg_length</span><span class="p">):</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">)</span>
        <span class="n">traj_segSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">seg_length</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span>
            <span class="n">traj_len</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">traj_len</span><span class="o">&gt;=</span><span class="n">seg_length</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj_len</span><span class="o">-</span><span class="n">seg_length</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#was -1, think that was an error, changed 2june21 because ended up missing data</span>
                    <span class="n">traj_seg</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ic</span><span class="p">:</span><span class="n">ic</span><span class="o">+</span><span class="n">seg_length</span><span class="p">]</span>
                    <span class="n">traj_segSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traj_segSet</span><span class="p">,</span><span class="n">traj_seg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">traj_segSet</span>

    <span class="k">def</span> <span class="nf">show_cells_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgdim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;cells_imgs&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">extract_cell_images</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
                <span class="n">ncells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgs</span><span class="p">)</span>
                <span class="n">nb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncells</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">nb</span><span class="p">,</span><span class="n">ic</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgs</span><span class="p">[</span><span class="n">ic</span><span class="p">],</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    <span class="c1">#plt.pause(.1)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ncells</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">)</span>
                <span class="n">nb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncells</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">nb</span><span class="p">,</span><span class="n">ic</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:,:],</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    <span class="c1">#plt.pause(.1)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;not in visual mode...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_cell_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">znormalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">ncells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgs</span><span class="p">)</span>
        <span class="n">cellSizes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncells</span><span class="p">):</span>
            <span class="n">cellSizes</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">])</span>
        <span class="n">maxedge</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mf">.5</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cellSizes</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxedge</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_cell_size</span><span class="p">:</span>
            <span class="n">maxedge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maximum_cell_size</span>
        <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="n">maxedge</span><span class="o">*</span><span class="n">maxedge</span><span class="p">))</span>
        <span class="n">Xm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncells</span><span class="p">,</span><span class="n">maxedge</span><span class="o">*</span><span class="n">maxedge</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncells</span><span class="p">):</span>
            <span class="n">img</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_imgs</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">imgp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">maxedge</span><span class="p">)</span>
            <span class="n">mskp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_image</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">maxedge</span><span class="p">)</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mskp</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">imgp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">imgp</span><span class="p">))</span>
            <span class="n">imgp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">imgp</span><span class="p">))</span>
            <span class="n">imgp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mskp</span><span class="p">))</span>
            <span class="n">mskp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">mskp</span><span class="p">))</span>
            <span class="n">mskp</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imga</span><span class="p">,</span><span class="n">mska</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">align_image</span><span class="p">(</span><span class="n">imgp</span><span class="p">,</span><span class="n">mskp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">imga</span><span class="o">=</span><span class="n">imgp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mska</span><span class="o">=</span><span class="n">mskp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">#imga=imgp</span>
            <span class="c1">#imgf=self.afft(imga)</span>
            <span class="k">if</span> <span class="n">znormalize</span><span class="p">:</span>
                <span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">znorm</span><span class="p">(</span><span class="n">imga</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span><span class="o">=</span><span class="n">imga</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1">#Xf[ic,:]=imgf.flatten()</span>
            <span class="n">Xm</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span><span class="o">=</span><span class="n">mska</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ic</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">znormalize</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Padding, aligning, znormalizing cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Padding, aligning, cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">=</span><span class="n">X</span>
        <span class="c1">#self.Xf=Xf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="o">=</span><span class="n">Xm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="o">=</span><span class="n">maxedge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="o">=</span><span class="n">ncells</span>

    <span class="k">def</span> <span class="nf">prepare_cell_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">apply_znorm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">Xf</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span>
        <span class="n">ic</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span>
        <span class="n">m1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span>
        <span class="n">x1fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featZernike</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">x1fh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featHaralick</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">x1fh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">znorm</span><span class="p">(</span><span class="n">x1fh</span><span class="p">)</span> <span class="c1">#apply for some relative normalization</span>
        <span class="n">x1fb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featBoundary</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
        <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_fmsks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="n">x1fcb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featBoundaryCB</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">fmsk</span><span class="p">)</span>
        <span class="n">ng</span><span class="o">=</span><span class="n">x1fg</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nh</span><span class="o">=</span><span class="n">x1fh</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nb</span><span class="o">=</span><span class="n">x1fb</span><span class="o">.</span><span class="n">size</span>
        <span class="n">ncb</span><span class="o">=</span><span class="n">x1fcb</span><span class="o">.</span><span class="n">size</span>
        <span class="n">indfg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ng</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indfh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span><span class="n">ng</span><span class="o">+</span><span class="n">nh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indfb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ng</span><span class="o">+</span><span class="n">nh</span><span class="p">,</span><span class="n">ng</span><span class="o">+</span><span class="n">nh</span><span class="o">+</span><span class="n">nb</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indfcb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ng</span><span class="o">+</span><span class="n">nh</span><span class="o">+</span><span class="n">nb</span><span class="p">,</span><span class="n">ng</span><span class="o">+</span><span class="n">nh</span><span class="o">+</span><span class="n">nb</span><span class="o">+</span><span class="n">ncb</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indfg</span><span class="o">=</span><span class="n">indfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indfh</span><span class="o">=</span><span class="n">indfh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indfb</span><span class="o">=</span><span class="n">indfb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indfcb</span><span class="o">=</span><span class="n">indfcb</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
            <span class="n">x1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span>
            <span class="n">m1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="p">[</span><span class="n">ic</span><span class="p">,:]</span>
            <span class="n">x1fg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featZernike</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">x1fh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featHaralick</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">x1fb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featBoundary</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
            <span class="n">msk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">fmsk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_fmsks</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
            <span class="n">x1fcb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">featBoundaryCB</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">fmsk</span><span class="p">)</span>
            <span class="n">x1f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ng</span><span class="o">+</span><span class="n">nh</span><span class="o">+</span><span class="n">nb</span><span class="o">+</span><span class="n">ncb</span><span class="p">)</span>
            <span class="n">x1f</span><span class="p">[</span><span class="n">indfg</span><span class="p">]</span><span class="o">=</span><span class="n">x1fg</span>
            <span class="n">x1f</span><span class="p">[</span><span class="n">indfh</span><span class="p">]</span><span class="o">=</span><span class="n">x1fh</span>
            <span class="n">x1f</span><span class="p">[</span><span class="n">indfb</span><span class="p">]</span><span class="o">=</span><span class="n">x1fb</span>
            <span class="n">x1f</span><span class="p">[</span><span class="n">indfcb</span><span class="p">]</span><span class="o">=</span><span class="n">x1fcb</span>
            <span class="n">Xf</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">x1f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ic</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;preparing RT invariant global, texture, boundary features for cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Xf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_image_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">img1</span><span class="p">,</span><span class="n">img2</span><span class="p">,</span><span class="n">msk1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">msk2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img1</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">img1</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">img2</span><span class="o">=</span><span class="n">img2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msk1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msk1</span><span class="o">=</span><span class="n">msk1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
                <span class="n">msk2</span><span class="o">=</span><span class="n">msk2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msk1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msk2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">msk2</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;not in visual mode...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dmatRT_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rows</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rows</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dmat_chunk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">dmat_chunk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
                <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_minRT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">row</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="p">[</span><span class="n">row</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pair_distRT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">row</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="p">[</span><span class="n">row</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xm</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                <span class="n">dmat_chunk</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dmat_row</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">dmat_chunk</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_dmatF_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rows</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rows</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">dmat_chunk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
                <span class="n">dmat_chunk</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xf</span><span class="p">[</span><span class="n">row</span><span class="p">,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xf</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dmat_row</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">dmat_chunk</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">objFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">+</span><span class="s1">&#39;.obj&#39;</span>
        <span class="n">objFileHandler</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">objFile</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">objFileHandler</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">objFileHandler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_dmat_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">dmat_row</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">dsetName</span> <span class="o">=</span> <span class="s1">&#39;/distance_matrix/row_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">dsetName</span> <span class="ow">in</span> <span class="n">f</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dsetName</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dmat_row</span><span class="p">))</span>
            <span class="n">dset</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">dmat_row</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;wrote dmat row &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;dmat row &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; already exists...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; overwriting</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">f</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">dsetName</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dmat_row</span><span class="p">))</span>
                <span class="n">dset</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">dmat_row</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">assemble_dmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">symmetrize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">f</span><span class="o">=</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">dmat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
            <span class="n">dsetName</span> <span class="o">=</span> <span class="s1">&#39;/distance_matrix/row_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">dsetName</span><span class="p">]</span>
            <span class="n">dmat</span><span class="p">[</span><span class="n">row</span><span class="p">,:]</span><span class="o">=</span><span class="n">dset</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="n">symmetrize</span><span class="p">:</span>
            <span class="n">dmat</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dmat</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dmat</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span><span class="o">=</span><span class="n">dmat</span>

    <span class="k">def</span> <span class="nf">get_scaled_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">neps</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">nr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#see Coifman, Shkolnisky, Sigworth, Singer, IEEE Transactions on Image Processing, 2008</span>
        <span class="n">dmat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dmat</span><span class="p">))]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">nr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nr</span><span class="o">&lt;</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nr</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nr</span><span class="o">&gt;=</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">indr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dmat</span><span class="o">=</span><span class="n">dmat</span><span class="p">[:,</span><span class="n">indr</span><span class="p">]</span>
        <span class="n">dmat</span><span class="o">=</span><span class="n">dmat</span><span class="p">[</span><span class="n">indr</span><span class="p">,:]</span>
        <span class="n">indpos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dmat</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">dmat</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">epsilonSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">geomspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dmat</span><span class="p">[</span><span class="n">indpos</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dmat</span><span class="p">[</span><span class="n">indpos</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">neps</span><span class="p">)</span>
        <span class="n">AsumSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">epsilonSet</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neps</span><span class="p">):</span>
            <span class="n">eps</span><span class="o">=</span><span class="n">epsilonSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">Asum</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dmat</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">eps</span><span class="p">)))</span>
            <span class="n">AsumSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">Asum</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;getting Amat sum for epsilon &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">neps</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">epsilonSet</span><span class="p">)</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">AsumSet</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="n">spl</span> <span class="o">=</span> <span class="n">csaps</span><span class="o">.</span><span class="n">CubicSmoothingSpline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="mf">1e0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="n">spl</span><span class="p">(</span><span class="n">xnew</span><span class="p">))</span>
        <span class="n">y1der</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">spl</span><span class="p">(</span><span class="n">xnew</span><span class="p">),</span><span class="n">xnew</span><span class="p">)</span>
        <span class="n">y2der</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">y1der</span><span class="p">,</span><span class="n">xnew</span><span class="p">)</span>
        <span class="n">y2der</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">y2der</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">indlin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">y2der</span><span class="p">)</span>
        <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">y1der</span><span class="p">[</span><span class="n">indlin</span><span class="p">]</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">xnew</span><span class="p">[</span><span class="n">indlin</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_sigma</span><span class="o">=</span><span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled_dim</span><span class="o">=</span><span class="n">dim</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dim</span><span class="o">*</span><span class="n">xnew</span><span class="o">+</span><span class="p">(</span><span class="n">spl</span><span class="p">(</span><span class="n">xnew</span><span class="p">)[</span><span class="n">indlin</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dim</span><span class="o">*</span><span class="n">xnew</span><span class="p">[</span><span class="n">indlin</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$\log{\sigma}$&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\log{\sum{\exp{-d^2/2\sigma}}}$&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nN</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaled_sigma</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#k=int(np.ceil(self.scaled_dim))</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">50</span>
        <span class="k">if</span> <span class="n">nN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nN</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">20.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dmat_knn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dmat_knn</span><span class="o">=</span><span class="n">dmat_knn</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span>
        <span class="n">dmat_knn</span><span class="o">=</span><span class="n">dmat_knn</span><span class="p">[:,</span><span class="n">inds</span><span class="p">]</span>
        <span class="n">indsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dmat_knn</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_test</span><span class="o">=</span><span class="n">inds</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_test</span><span class="p">):</span>
            <span class="n">dmat_knn</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">indsort</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">nN</span><span class="p">:]]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">A</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">dmat_knn</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_test</span><span class="p">):</span> <span class="c1">#row normalize</span>
            <span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="p">,:]</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="p">,:]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">row</span><span class="p">,:])</span>
        <span class="n">A</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">eigvals</span><span class="p">,</span><span class="n">eigvecs</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eigvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
        <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span>
        <span class="n">eigvals</span><span class="o">=</span><span class="n">eigvals</span><span class="p">[</span><span class="n">indsort</span><span class="p">]</span>
        <span class="n">dmap_evals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">])</span>
        <span class="n">dmap_evecs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_test</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
        <span class="n">eigvecs</span><span class="o">=</span><span class="n">eigvecs</span><span class="p">[:,</span><span class="n">indsort</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">dmap_evecs</span><span class="p">[:,</span><span class="n">idim</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">[:,</span><span class="n">idim</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">eigvecs</span><span class="p">[:,</span><span class="n">k</span><span class="p">])))</span>
        <span class="n">Xd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
        <span class="c1">#Xd=dmap_evecs[inds,:]</span>
        <span class="n">Xd</span><span class="p">[</span><span class="n">inds</span><span class="p">,:]</span><span class="o">=</span><span class="n">dmap_evecs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">Xd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmap_evals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">dmap_evals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rcut</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span><span class="n">nd</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nN</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nout</span><span class="o">=</span><span class="mi">1000</span>
        <span class="n">indsp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">nout</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">noutp</span><span class="o">=</span><span class="n">nout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">nN</span><span class="o">=</span><span class="n">nN</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
            <span class="n">cp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nd</span><span class="p">):</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="n">idm</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">indinf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">x</span><span class="p">[</span><span class="n">indinf</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">cp1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="n">idm</span><span class="p">]</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">cp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cp1</span><span class="p">,</span><span class="n">cp</span><span class="p">)</span>
                <span class="n">c1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="n">idm</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">&lt;</span><span class="n">rcut</span>
                <span class="n">cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span><span class="n">c1</span><span class="p">)</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cm</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cout</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cm</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span>
            <span class="n">nout</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cout</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;pruned &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nout</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cells beyond &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rcut</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; std...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">indsp</span><span class="o">=</span><span class="n">inds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_trajectory_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trajl</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">get_trajectories</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">neigen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rcut</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_trajectories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_trajectories</span><span class="p">(</span><span class="n">cell_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
        <span class="n">traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="n">trajl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">=</span><span class="n">trajl</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span><span class="p">[</span><span class="n">traj</span><span class="p">,:]</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">trajl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_scaled_sigma</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune_embedding</span><span class="p">(</span><span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span><span class="n">rcut</span><span class="o">=</span><span class="n">rcut</span><span class="p">)</span>
        <span class="n">indst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indst</span><span class="o">=</span><span class="n">indst</span>
        <span class="k">if</span> <span class="n">neigen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neigen</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaled_dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xtraj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">neigen</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_trajectory_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">traj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Xtraj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">get_trajectories</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nlag</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#traj and Xtraj should be indexed same</span>
        <span class="k">if</span> <span class="n">inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indSet</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_trajectories</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_unique_trajectories</span><span class="p">(</span><span class="n">cell_inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span>
        <span class="k">if</span> <span class="n">Xtraj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtraj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">Xtraj</span>
        <span class="n">trajp1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_segments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">+</span><span class="n">nlag</span><span class="p">)</span>
        <span class="n">inds_nlag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="o">+</span><span class="n">nlag</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">nlag</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1">#keep indices every nlag</span>
        <span class="n">trajp1</span><span class="o">=</span><span class="n">trajp1</span><span class="p">[:,</span><span class="n">inds_nlag</span><span class="p">]</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">trajp1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neigen</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">neigen</span><span class="p">))</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">neigen</span><span class="p">))</span>
        <span class="n">inds_trajp1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">test0</span><span class="o">=</span><span class="n">trajp1</span><span class="p">[</span><span class="n">itraj</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">test1</span><span class="o">=</span><span class="n">trajp1</span><span class="p">[</span><span class="n">itraj</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">res0</span> <span class="o">=</span> <span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">test0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">res1</span> <span class="o">=</span> <span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">test1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res0</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indt0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">indt0</span><span class="p">,:]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">inds_trajp1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_trajp1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">indt0</span><span class="p">,</span><span class="n">indt1</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">itraj</span><span class="o">%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;matching up trajectory &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itraj</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xtraj0</span><span class="o">=</span><span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xtraj1</span><span class="o">=</span><span class="n">x1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inds_trajp1</span><span class="o">=</span><span class="n">inds_trajp1</span>

    <span class="k">def</span> <span class="nf">get_Xtraj_celltrajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">Xtraj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">traj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#traj and</span>
        <span class="k">if</span> <span class="n">traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span>
        <span class="k">if</span> <span class="n">Xtraj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtraj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">Xtraj</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
        <span class="n">neigen</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">neigen</span><span class="p">))</span>
        <span class="n">inds_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="p">):</span>
            <span class="n">test</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">itraj</span><span class="p">:</span><span class="n">itraj</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">trajl</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">traj</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">==</span> <span class="n">test</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">indt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">xt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">inds_traj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inds_traj</span><span class="p">,</span><span class="n">indt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xt</span><span class="p">,</span><span class="n">inds_traj</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell_inds</span><span class="p">,</span><span class="n">show_segs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
                <span class="n">indstride</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">cell_inds</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">stride</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">cell_inds</span><span class="o">=</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">indstride</span><span class="p">]</span>
                <span class="n">ncells</span><span class="o">=</span><span class="n">cell_inds</span><span class="o">.</span><span class="n">size</span>
                <span class="n">nb</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncells</span><span class="p">)))</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
                <span class="c1">#plt.figure(figsize=(12,16))</span>
                <span class="c1">#fig,ax=plt.subplots(nrows=nb,ncols=2,sharex=&#39;all&#39;,sharey=&#39;all&#39;)</span>
                <span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nb</span><span class="o">*</span><span class="n">nb</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">inds2d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">inds</span><span class="p">,(</span><span class="n">nb</span><span class="p">,</span><span class="n">nb</span><span class="p">))</span>
                <span class="n">inds2d1b</span><span class="o">=</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="n">nb</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nb</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">inds2d1b</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">inds2d1b</span><span class="p">[</span><span class="n">ir</span><span class="p">])</span>
                <span class="n">inds2d</span><span class="o">=</span><span class="p">(</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">inds2d1b</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="o">*</span><span class="n">nb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ic</span><span class="o">&lt;</span><span class="n">ncells</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">get_cellborder_images</span><span class="p">(</span><span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cell_inds</span><span class="p">[</span><span class="n">ic</span><span class="p">]]),</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
                        <span class="n">imgcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">mskcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fmskcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_fmsks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">ccborder</span><span class="p">,</span><span class="n">csborder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">mskcell</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">)</span>
                        <span class="n">img_fg</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmskcell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imgcell</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">img_bg</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmskcell</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imgcell</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                        <span class="n">nx</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
                        <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
                        <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">show_segs</span><span class="p">:</span>
                            <span class="n">scatter_cc</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                            <span class="n">scatter_cs</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">scatter_x</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cmsky</span><span class="p">,</span><span class="n">cmskx</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ic</span><span class="p">],</span><span class="n">inds2d</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ic</span><span class="p">]]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;not in visual mode...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cluster_trajectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xtraj</span>
        <span class="n">clusters</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">cluster_kmeans</span><span class="p">([</span><span class="n">x</span><span class="p">],</span><span class="n">k</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusterst</span><span class="o">=</span><span class="n">clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_clusterst</span><span class="o">=</span><span class="n">n_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indclusterst</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_transition_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusterst</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">clustercenters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indc0</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">indc1</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">Cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">n_clusters</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">itt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">Cm</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itt</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itt</span><span class="p">]]</span><span class="o">=</span><span class="n">Cm</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itt</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itt</span><span class="p">]]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">Mt</span><span class="o">=</span><span class="n">Cm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sM</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Mt</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iR</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sM</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">Mt</span><span class="p">[</span><span class="n">iR</span><span class="p">,:]</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">iR</span><span class="p">,:]</span><span class="o">/</span><span class="n">sM</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sM</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span><span class="o">==</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="n">Mt</span><span class="p">[</span><span class="n">iR</span><span class="p">,</span><span class="n">iR</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mt</span><span class="o">=</span><span class="n">Mt</span>

    <span class="k">def</span> <span class="nf">get_transition_matrix_CG</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">clusters</span><span class="p">,</span><span class="n">states</span><span class="p">):</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">clustercenters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">states</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">indc0</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x0</span><span class="p">)]</span>
        <span class="n">indc1</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x1</span><span class="p">)]</span>
        <span class="n">Cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_states</span><span class="p">,</span><span class="n">n_states</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">itt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">Cm</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itt</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itt</span><span class="p">]]</span><span class="o">=</span><span class="n">Cm</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itt</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itt</span><span class="p">]]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">Mt</span><span class="o">=</span><span class="n">Cm</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sM</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Mt</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iR</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_states</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sM</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">Mt</span><span class="p">[</span><span class="n">iR</span><span class="p">,:]</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">iR</span><span class="p">,:]</span><span class="o">/</span><span class="n">sM</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sM</span><span class="p">[</span><span class="n">iR</span><span class="p">]</span><span class="o">==</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="n">Mt</span><span class="p">[</span><span class="n">iR</span><span class="p">,</span><span class="n">iR</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">Mt</span>

    <span class="k">def</span> <span class="nf">get_path_entropy_2point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Mt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude_stays</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusterst</span>
        <span class="k">if</span> <span class="n">Mt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Mt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Mt</span>
        <span class="n">indc0</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">indc1</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">entp</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">itt</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">exclude_stays</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">!=</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">]:</span>
                        <span class="n">itt</span><span class="o">=</span><span class="n">itt</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">pt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span>
                        <span class="n">entp</span><span class="o">=</span><span class="n">entp</span><span class="o">-</span><span class="n">pt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span> <span class="c1"># and Mt[indc1[itraj],indc0[itraj]]&gt;0.:</span>
                        <span class="n">itt</span><span class="o">=</span><span class="n">itt</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">pt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span>
                        <span class="n">entp</span><span class="o">=</span><span class="n">entp</span><span class="o">-</span><span class="n">pt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
            <span class="n">entp</span><span class="o">=</span><span class="n">entp</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">itt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;empty arrays or failed calc</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">entp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">entp</span>

    <span class="k">def</span> <span class="nf">get_path_ll_2point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Mt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude_stays</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusterst</span>
        <span class="k">if</span> <span class="n">Mt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Mt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Mt</span>
        <span class="n">indc0</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">indc1</span><span class="o">=</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">ll</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="n">itt</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">exclude_stays</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">!=</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">]:</span>
                        <span class="n">itt</span><span class="o">=</span><span class="n">itt</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">pt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span>
                        <span class="n">ll</span><span class="o">=</span><span class="n">ll</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span> <span class="c1"># and Mt[indc1[itraj],indc0[itraj]]&gt;0.:</span>
                        <span class="n">itt</span><span class="o">=</span><span class="n">itt</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">pt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span>
                        <span class="n">ll</span><span class="o">=</span><span class="n">ll</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
            <span class="n">ll</span><span class="o">=</span><span class="n">ll</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">itt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;empty arrays or failed calc</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ll</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">ll</span>

    <span class="k">def</span> <span class="nf">get_kscore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Mt</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">):</span> <span class="c1">#,nw=10):</span>
        <span class="n">indeye</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">Mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">diag</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indeye</span><span class="p">]</span>
        <span class="n">indgood</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diag</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Mt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indgood</span><span class="p">,:]</span>
        <span class="n">Mt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[:,</span><span class="n">indgood</span><span class="p">]</span>
        <span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Mt</span><span class="p">))</span>
        <span class="n">w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">&lt;</span><span class="n">eps</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">indw</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">&gt;</span><span class="n">eps</span><span class="p">,</span><span class="n">w</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">),</span><span class="n">w</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">))</span>
            <span class="n">tw</span><span class="o">=</span><span class="n">w</span><span class="p">[</span><span class="n">indw</span><span class="p">]</span>
            <span class="n">tw</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tw</span><span class="p">)</span>
            <span class="c1">#tw=tw[-nw:]</span>
            <span class="n">tw</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">tw</span><span class="p">)</span>
            <span class="n">kscore</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kscore</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">kscore</span>

    <span class="k">def</span> <span class="nf">get_entropy_production</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Mt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">trajectories</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">states</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trajectories</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trajectories</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span>
        <span class="n">entp_production</span><span class="o">=</span><span class="mf">0.</span>
        <span class="n">ntraj_total</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
            <span class="n">cell_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trajectories</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span>
            <span class="n">xt</span><span class="p">,</span><span class="n">inds_traj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_Xtraj_celltrajectory</span><span class="p">(</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">Xtraj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">traj</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">ll_f</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_ll_gmean</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="n">clusters</span><span class="p">,</span><span class="n">Mt</span><span class="o">=</span><span class="n">Mt</span><span class="p">,</span><span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="n">ll_r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_traj_ll_gmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">xt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">clusters</span><span class="o">=</span><span class="n">clusters</span><span class="p">,</span><span class="n">Mt</span><span class="o">=</span><span class="n">Mt</span><span class="p">,</span><span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ll_f</span><span class="o">&gt;</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">ll_r</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
                <span class="n">entp_p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ll_f</span><span class="o">/</span><span class="n">ll_r</span><span class="p">)</span>
                <span class="n">ntraj_total</span><span class="o">=</span><span class="n">ntraj_total</span><span class="o">+</span><span class="mi">1</span>  
                <span class="n">entp_production</span><span class="o">=</span><span class="n">entp_production</span><span class="o">+</span><span class="n">entp_p</span>
        <span class="n">entp_production</span><span class="o">=</span><span class="n">entp_production</span><span class="o">/</span><span class="n">ntraj_total</span>
        <span class="k">return</span> <span class="n">entp_production</span>

    <span class="k">def</span> <span class="nf">get_traj_ll_gmean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xt</span><span class="p">,</span><span class="n">clusters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Mt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude_stays</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">states</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clusters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clusterst</span>
        <span class="k">if</span> <span class="n">Mt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Mt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Mt</span>
        <span class="k">if</span> <span class="n">states</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">states</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">x0</span><span class="o">=</span><span class="n">xt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">xt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">indc0</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x0</span><span class="p">)]</span>
        <span class="n">indc1</span><span class="o">=</span><span class="n">states</span><span class="p">[</span><span class="n">clusters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x1</span><span class="p">)]</span>
        <span class="n">llSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">itt</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">ntraj</span><span class="o">=</span><span class="n">indc0</span><span class="o">.</span><span class="n">size</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">itraj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntraj</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">exclude_stays</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span> <span class="ow">and</span> <span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]</span><span class="o">!=</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">]:</span>
                        <span class="n">itt</span><span class="o">=</span><span class="n">itt</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">pt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span>
                        <span class="n">llSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">llSet</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span> <span class="c1"># and Mt[indc1[itraj],indc0[itraj]]&gt;0.:</span>
                        <span class="n">itt</span><span class="o">=</span><span class="n">itt</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">pt</span><span class="o">=</span><span class="n">Mt</span><span class="p">[</span><span class="n">indc0</span><span class="p">[</span><span class="n">itraj</span><span class="p">],</span><span class="n">indc1</span><span class="p">[</span><span class="n">itraj</span><span class="p">]]</span>
                        <span class="n">llSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">llSet</span><span class="p">,</span><span class="n">pt</span><span class="p">)</span>
            <span class="n">ll_mean</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mstats</span><span class="o">.</span><span class="n">gmean</span><span class="p">(</span><span class="n">llSet</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;empty arrays or failed calc</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ll_mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">ll_mean</span>

    <span class="k">def</span> <span class="nf">plot_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">nd</span><span class="o">=</span><span class="mi">12</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nd</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">dmap_evals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nd</span><span class="p">],</span><span class="s1">&#39;ko--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;eigenvalue index&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;eigenvalue (1 is stationary)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="n">ip</span><span class="o">=</span><span class="mi">0</span>
            <span class="nb">id</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xd</span><span class="p">[:,</span><span class="nb">id</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;DM &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;DM 1&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not in visual mode.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">explore_2D_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pathto</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">nvis</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">coordlabel</span><span class="o">=</span><span class="s1">&#39;coord&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">ipath</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dm1</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">dm2</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm2</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm1</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">distSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
                    <span class="n">distSet</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">ic</span><span class="p">,</span><span class="n">dm2</span><span class="p">]]),</span><span class="n">pts</span><span class="p">)</span>
                <span class="n">ind_nn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">distSet</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ind_nn</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">distSet_Xd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
                    <span class="n">distSet_Xd</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ind_nn</span><span class="p">[</span><span class="mi">0</span><span class="p">],:],</span><span class="n">x</span><span class="p">[</span><span class="n">ic</span><span class="p">,:])</span>
                <span class="n">ind_nn_Xd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">distSet</span><span class="p">)</span>
                <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ind_nn_Xd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nvis</span><span class="p">],:]</span>
                <span class="n">ncells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ncells</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">)</span>
                <span class="n">nb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ncells</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">img</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span>
                <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ncells</span><span class="p">):</span>
                    <span class="n">img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">img</span><span class="p">,</span><span class="n">X</span><span class="p">[</span><span class="n">ic</span><span class="p">,:,:]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">imgfile</span><span class="o">=</span><span class="n">pathto</span><span class="o">+</span><span class="s2">&quot;image</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">ipath</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)</span>
                <span class="n">ipath</span><span class="o">=</span><span class="n">ipath</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not in visual mode</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">explore_2D_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">cell_traj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pathto</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">coordlabel</span><span class="o">=</span><span class="s1">&#39;coord&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell_traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">maxpoints</span><span class="o">=</span><span class="mi">100</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxpoints</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="n">nx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
            <span class="n">maxdx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span> <span class="n">mindx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]);</span>
            <span class="n">maxdy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span> <span class="n">mindy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]);</span>
            <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">ipath</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dm1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">dm2</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm2</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm1</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ptSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxpoints</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cell_traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pts</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ip</span><span class="p">],</span><span class="n">dm2</span><span class="p">]])]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ptSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ptSet</span><span class="p">,</span><span class="n">pts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">scatter_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ip</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ptSet</span><span class="p">[</span><span class="n">ip</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">ptSet</span><span class="p">[</span><span class="n">ip</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">ip</span><span class="o">/</span><span class="n">maxpoints</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cell_traj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">img_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ind_nn</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">img_pts</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ip</span><span class="p">],:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">maxedge</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">im</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="p">[</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ip</span><span class="p">]]</span>
                <span class="n">indt1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_indimgSet</span><span class="o">==</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">img1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
                <span class="n">msk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mskSet</span><span class="p">[</span><span class="n">im</span><span class="p">,:,:]</span>
                <span class="n">xt1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">indt1</span><span class="p">,:]</span>
                <span class="n">contour1_img</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">yy</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">imgSet_t</span><span class="p">[</span><span class="n">im</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">img1</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>
                <span class="n">indct1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indt1</span><span class="o">==</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                <span class="n">scatter1_img</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xt1</span><span class="p">[</span><span class="n">indct1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">xt1</span><span class="p">[</span><span class="n">indct1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">mindx</span><span class="p">,</span><span class="n">maxdx</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">mindy</span><span class="p">,</span><span class="n">maxdy</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="n">imgfile</span><span class="o">=</span><span class="n">pathto</span><span class="o">+</span><span class="s2">&quot;image</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">ipath</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="n">scatter_pts</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="n">ipath</span><span class="o">=</span><span class="n">ipath</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not in visual mode</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">explore_2D_celltraj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">traj</span><span class="p">,</span><span class="n">cell_traj</span><span class="p">,</span><span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pathto</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">coordlabel</span><span class="o">=</span><span class="s1">&#39;coord&#39;</span><span class="p">,</span><span class="n">show_segs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">ipath</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dm1</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">dm2</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">trajl</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ptSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">nt</span><span class="o">=</span><span class="n">cell_traj</span><span class="o">.</span><span class="n">size</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="o">-</span><span class="n">trajl</span><span class="p">):</span>
                <span class="n">test</span><span class="o">=</span><span class="n">cell_traj</span><span class="p">[</span><span class="n">it</span><span class="p">:</span><span class="n">it</span><span class="o">+</span><span class="n">trajl</span><span class="p">]</span>
                <span class="n">is_seq</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">ii</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">is_seq</span> <span class="ow">and</span> <span class="n">ii</span><span class="o">&lt;</span><span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">ii</span><span class="o">=</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">is_seq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seq_in_seq</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="n">traj</span><span class="p">[</span><span class="n">ii</span><span class="p">,:])</span>
                <span class="k">if</span> <span class="n">is_seq</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">trajl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm2</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm1</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">pts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">x</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">dm2</span><span class="p">]]])</span>
                    <span class="n">ptSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ptSet</span><span class="p">,</span><span class="n">pts</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ptSet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">ptSet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nt</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ptSet</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">ptSet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                    <span class="n">traj_it</span><span class="o">=</span><span class="n">traj</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span>
                    <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trajl</span><span class="p">):</span>
                         <span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">trajl</span><span class="p">,</span><span class="n">il</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                         <span class="c1">#img=self.X[traj_it[il],:].reshape(self.maxedge,self.maxedge)</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">get_cellborder_images</span><span class="p">(</span><span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">traj_it</span><span class="p">[</span><span class="n">il</span><span class="p">]]),</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
                         <span class="n">imgcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="n">mskcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="n">fmskcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_fmsks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="n">ccborder</span><span class="p">,</span><span class="n">csborder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">mskcell</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">)</span>
                         <span class="n">img_fg</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmskcell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imgcell</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                         <span class="n">img_bg</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmskcell</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imgcell</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                         <span class="n">nx</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                         <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
                         <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
                         <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">show_segs</span><span class="p">:</span>
                             <span class="n">scatter_cc</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                             <span class="n">scatter_cs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                         <span class="k">else</span><span class="p">:</span>
                             <span class="n">scatter_x</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cmsky</span><span class="p">,</span><span class="n">cmskx</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                         <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                         <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">traj_it</span><span class="p">[</span><span class="n">il</span><span class="p">]))</span>
                         <span class="c1">#plt.imshow(img,cmap=plt.cm.seismic,clim=(-10,10))</span>
                         <span class="c1">#plt.axis(&#39;off&#39;)</span>
                    <span class="c1">#plt.tight_layout()</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
                    <span class="n">imgfile</span><span class="o">=</span><span class="n">pathto</span><span class="o">+</span><span class="s2">&quot;image</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">ipath</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)</span>
                    <span class="n">ipath</span><span class="o">=</span><span class="n">ipath</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;cell traj not found in traj set</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not in visual mode</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">explore_2D_celltraj_nn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">traj</span><span class="p">,</span><span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">npts</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">dm1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">dm2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">pathto</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="n">coordlabel</span><span class="o">=</span><span class="s1">&#39;coord&#39;</span><span class="p">,</span><span class="n">show_segs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">ipath</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">trajl</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dm1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dm1</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">dm2</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">indx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dm1</span><span class="p">,</span><span class="n">dm2</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">trajl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">scatter_x</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm2</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;choose &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; points&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">ginput</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">npts</span><span class="o">=</span><span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1">#xc=np.array([x[traj[:,0],dm1],x[traj[:,0],dm2]]).T</span>
            <span class="n">xc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm2</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">dmat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">xc</span><span class="p">,</span><span class="n">pts</span><span class="p">)</span>
            <span class="n">dmat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dmat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dmat</span><span class="p">)))]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">ind_nn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts</span><span class="p">):</span>
                <span class="n">ind_nn</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dmat</span><span class="p">[:,</span><span class="n">ip</span><span class="p">])</span>
            <span class="n">ind_nn</span><span class="o">=</span><span class="n">ind_nn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ptSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ipts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">trajl</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">scatter_x</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm1</span><span class="p">],</span><span class="n">x</span><span class="p">[:,</span><span class="n">dm2</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="n">ipts</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">pts</span><span class="p">[</span><span class="n">ipts</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm1</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">coordlabel</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dm2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">traj_it</span><span class="o">=</span><span class="n">traj</span><span class="p">[</span><span class="n">ind_nn</span><span class="p">[</span><span class="n">ipts</span><span class="p">],:]</span>
                <span class="k">for</span> <span class="n">il</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trajl</span><span class="p">):</span>
                    <span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">trajl</span><span class="p">,</span><span class="n">il</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_cellborder_images</span><span class="p">(</span><span class="n">indcells</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">traj_it</span><span class="p">[</span><span class="n">il</span><span class="p">]]),</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
                    <span class="n">imgcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mskcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_msks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fmskcell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cellborder_fmsks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ccborder</span><span class="p">,</span><span class="n">csborder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">mskcell</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">)</span>
                    <span class="n">img_fg</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmskcell</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imgcell</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">img_bg</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">fmskcell</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imgcell</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
                    <span class="n">nx</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="n">imgcell</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
                    <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
                    <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">mskcell</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">show_segs</span><span class="p">:</span>
                        <span class="n">scatter_cc</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                        <span class="n">scatter_cs</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scatter_x</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cmsky</span><span class="p">,</span><span class="n">cmskx</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;cell &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">traj_it</span><span class="p">[</span><span class="n">il</span><span class="p">]))</span>
                <span class="c1">#plt.tight_layout()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.5</span><span class="p">)</span>
                <span class="n">imgfile</span><span class="o">=</span><span class="n">pathto</span><span class="o">+</span><span class="s2">&quot;image</span><span class="si">%04d</span><span class="s2">.png&quot;</span> <span class="o">%</span> <span class="n">ipath</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imgfile</span><span class="p">)</span>
                <span class="n">ipath</span><span class="o">=</span><span class="n">ipath</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Not in visual mode</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">var_cutoff</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="n">pca</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xf</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">var_cutoff</span><span class="o">=</span><span class="n">var_cutoff</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x</span><span class="o">=</span><span class="n">pca</span><span class="o">.</span><span class="n">get_output</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">=</span><span class="n">pca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span><span class="o">=</span><span class="n">x</span>

    <span class="k">def</span> <span class="nf">get_pca_fromdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">var_cutoff</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="n">pca</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">var_cutoff</span><span class="o">=</span><span class="n">var_cutoff</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x</span><span class="o">=</span><span class="n">pca</span><span class="o">.</span><span class="n">get_output</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">pca</span>

    <span class="k">def</span> <span class="nf">cluster_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span>
        <span class="n">nC</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">cluster_kmeans</span><span class="p">([</span><span class="n">x</span><span class="p">],</span><span class="n">k</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span> <span class="c1">#,max_iter=100)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusterFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modelName</span><span class="o">+</span><span class="s1">&#39;_nc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusterFile</span><span class="p">,</span> <span class="n">save_streaming_chain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_pca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nd</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
            <span class="n">nd</span><span class="o">=</span><span class="mi">12</span>
            <span class="n">nplots</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">nrows</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nplots</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nd</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nd</span><span class="p">],</span><span class="s1">&#39;ko--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;eigenvalue index&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PCA eigenvalue&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
            <span class="n">ip</span><span class="o">=</span><span class="mi">0</span>
            <span class="nb">id</span><span class="o">=</span><span class="mi">2</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">pca</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="nb">id</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Xpca</span><span class="p">[:,</span><span class="n">ip</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PCA &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ip</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PCA 1&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="o">+</span><span class="mi">1</span>
                                                                            
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pad_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">maxedge</span><span class="p">):</span>
        <span class="n">npad_lx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">maxedge</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">npad_lx</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">npad_lx</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">npad_ly</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">maxedge</span><span class="o">-</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">npad_ly</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">npad_ly</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,((</span><span class="n">npad_lx</span><span class="p">,</span><span class="n">npad_lx</span><span class="p">),(</span><span class="n">npad_ly</span><span class="p">,</span><span class="n">npad_ly</span><span class="p">)),</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">maxedge</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">maxedge</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">align_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">msk</span><span class="p">):</span>
        <span class="n">img0</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#img=np.abs(img)</span>
        <span class="c1">#msk=img</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">cmskx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">msk</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">cmsky</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">msk</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="c1">#msk=np.abs(np.fft.fftshift(np.fft.fft2(msk)))</span>
        <span class="n">I</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">,</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">))))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">,</span><span class="n">yy</span><span class="o">-</span><span class="n">cmsky</span><span class="p">))))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">I</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">I</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">cmskx</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">cmsky</span><span class="p">,</span><span class="n">yy</span><span class="o">-</span><span class="n">cmsky</span><span class="p">))))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=-</span><span class="n">cmskx</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cmsky</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cmskx</span><span class="o">+</span><span class="p">(</span><span class="n">cmskx</span><span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=-</span><span class="n">cmskx</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cmsky</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">cmsky</span><span class="o">+</span><span class="p">(</span><span class="n">cmsky</span><span class="o">-</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">tform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">SimilarityTransform</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">)</span>
        <span class="n">mska</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">tform</span><span class="p">)</span>
        <span class="n">imga</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">img0</span><span class="p">,</span><span class="n">tform</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imga</span><span class="p">,</span> <span class="n">mska</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_image</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x1</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">centerx</span><span class="o">=</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">centery</span><span class="o">=</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">th</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">trans</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">tmatrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=-</span><span class="n">centerx</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">centery</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">centerx</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=-</span><span class="n">centerx</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">-</span><span class="n">centery</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">centery</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">tform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">SimilarityTransform</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">)</span>
        <span class="n">x1rt</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">tform</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x1rt</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span><span class="n">img2</span><span class="p">):</span>
        <span class="c1">#img1=img1.astype(float).flatten()</span>
        <span class="c1">#img2=img2.astype(float).flatten()</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">img1</span><span class="o">-</span><span class="n">img2</span><span class="p">),</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">dist</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_dmat</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="c1">#adapted to python from Russell Fung matlab implementation (github.com/ki-analysis/manifold-ga dmat.m)</span>
        <span class="n">x1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="c1">#default from Fung folks is D x N</span>
        <span class="k">if</span> <span class="n">x2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nX1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span><span class="n">nX1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="c1"># Iron-out numerical wrinkles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
            <span class="n">nX1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nX2</span> <span class="o">=</span> <span class="n">x2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span> <span class="p">),</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nX2</span> <span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span> <span class="p">),</span> <span class="n">nX1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span><span class="n">x2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">afft</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">fimg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">fimg</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">znorm</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">z</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dist_with_masks</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">):</span>
        <span class="n">cm</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">cm</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">cm</span><span class="p">),</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dist</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">featZernike</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">degree</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">radius</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">degree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">degree</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mahotas</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">zernike_moments</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">radius</span><span class="p">,</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">featHaralick</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nlevels</span><span class="o">=</span><span class="mi">21</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">nlevels</span><span class="p">)</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">nlevels</span><span class="o">=</span><span class="n">levels</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">imgn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">levels</span><span class="p">)</span>
        <span class="n">feath</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mahotas</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">haralick</span><span class="p">(</span><span class="n">imgn</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">feath</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="n">feath</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="n">nlevels</span> <span class="c1">#feature 5 is sum average which is way over scale with average of nlevels</span>
        <span class="k">return</span> <span class="n">feath</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">featBoundary</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">ncomp</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nth</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">msk</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">border</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">borders</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">center</span><span class="o">=</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">bordercoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">border</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">center</span>
            <span class="n">rcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bordercoords</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">bordercoords</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">bordercoords</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">bordercoords</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
            <span class="n">indth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">)</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">thetacoords</span><span class="p">[</span><span class="n">indth</span><span class="p">]</span>
            <span class="n">rcoords</span><span class="o">=</span><span class="n">rcoords</span><span class="p">[</span><span class="n">indth</span><span class="p">]</span>
            <span class="n">thetacoords</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rcoords</span><span class="o">=</span><span class="n">rcoords</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">rcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rcoords</span><span class="p">,</span><span class="n">rcoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rcoords</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">rcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">spl</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="n">rcoords</span><span class="p">)</span>
            <span class="n">thetaset</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">thetaset</span><span class="o">=</span><span class="n">thetaset</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rth</span><span class="o">=</span><span class="n">spl</span><span class="p">(</span><span class="n">thetaset</span><span class="p">)</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">rth</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">thetaset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thetaset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">indf</span><span class="o">=</span><span class="n">freq</span><span class="o">&gt;=</span><span class="mi">0</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">[</span><span class="n">indf</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="p">[</span><span class="n">indf</span><span class="p">]</span>
            <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">[</span><span class="n">indsort</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="p">[</span><span class="n">indsort</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ncomp</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rtha</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rtha</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">rtha</span>

    <span class="k">def</span> <span class="nf">featBoundaryCB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msk</span><span class="p">,</span><span class="n">fmsk</span><span class="p">,</span><span class="n">ncomp</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">nth</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msk</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">msk</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                <span class="n">msk</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
                <span class="n">fmsk</span><span class="o">=</span><span class="n">fmsk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">ccborder</span><span class="p">,</span><span class="n">csborder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">fmsk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nx</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ny</span><span class="o">=</span><span class="n">msk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nx</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">ny</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span>
            <span class="n">bordercoords_cc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">thetacoords_cc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">bordercoords_cc</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">bordercoords_cc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
            <span class="n">cbcoords_cc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">thetacoords_cc</span><span class="p">)</span>
            <span class="n">bordercoords_cs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">thetacoords_cs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">bordercoords_cs</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">bordercoords_cs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
            <span class="n">cbcoords_cs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">thetacoords_cs</span><span class="p">)</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thetacoords_cc</span><span class="p">,</span><span class="n">thetacoords_cs</span><span class="p">)</span>
            <span class="n">cbcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbcoords_cc</span><span class="p">,</span><span class="n">cbcoords_cs</span><span class="p">)</span>
            <span class="n">indth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">)</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">thetacoords</span><span class="p">[</span><span class="n">indth</span><span class="p">]</span>
            <span class="n">cbcoords</span><span class="o">=</span><span class="n">cbcoords</span><span class="p">[</span><span class="n">indth</span><span class="p">]</span>
            <span class="n">thetacoords</span><span class="p">,</span><span class="n">inds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cbcoords</span><span class="o">=</span><span class="n">cbcoords</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">thetacoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">cbcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbcoords</span><span class="p">,</span><span class="n">cbcoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cbcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cbcoords</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cbcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">spl</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">thetacoords</span><span class="p">,</span><span class="n">cbcoords</span><span class="p">)</span>
            <span class="n">thetaset</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">thetaset</span><span class="o">=</span><span class="n">thetaset</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rth</span><span class="o">=</span><span class="n">spl</span><span class="p">(</span><span class="n">thetaset</span><span class="p">)</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">rth</span><span class="p">))</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">rth</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="n">thetaset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">thetaset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">indf</span><span class="o">=</span><span class="n">freq</span><span class="o">&gt;=</span><span class="mi">0</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">[</span><span class="n">indf</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="p">[</span><span class="n">indf</span><span class="p">]</span>
            <span class="n">indsort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">[</span><span class="n">indsort</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="p">[</span><span class="n">indsort</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ncomp</span><span class="p">]</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">rtha</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">nth</span><span class="p">)</span> <span class="c1">#we do want the scale for boundary fraction</span>
            <span class="k">return</span> <span class="n">rtha</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rtha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ncomp</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span><span class="p">(</span><span class="n">rtha</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_neg_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">m0</span><span class="p">,</span><span class="n">m1</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_image</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="n">neg_overlap</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">m0</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">m1</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">neg_overlap</span>

    <span class="k">def</span> <span class="nf">get_minT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">nt</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nt</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nt</span><span class="o">=</span><span class="n">nt</span><span class="o">+</span><span class="mi">1</span> <span class="c1">#should be zero in the set!</span>
        <span class="n">ttSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">dt</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">xxt</span><span class="p">,</span><span class="n">yyt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ttSet</span><span class="p">,</span><span class="n">ttSet</span><span class="p">)</span>
        <span class="n">overlapSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nt</span><span class="o">*</span><span class="n">nt</span><span class="p">)</span>
        <span class="n">xxt</span><span class="o">=</span><span class="n">xxt</span><span class="o">.</span><span class="n">flatten</span><span class="p">();</span> <span class="n">yyt</span><span class="o">=</span><span class="n">yyt</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="o">*</span><span class="n">nt</span><span class="p">):</span>
            <span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="n">xxt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">yyt</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">overlapSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_neg_overlap</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
        <span class="n">overlapSet</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">overlapSet</span><span class="p">))]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">imin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">overlapSet</span><span class="p">)</span>
        <span class="n">tmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="n">xxt</span><span class="p">[</span><span class="n">imin</span><span class="p">],</span><span class="n">yyt</span><span class="p">[</span><span class="n">imin</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">tmin</span>

    <span class="k">def</span> <span class="nf">get_pair_distRT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x1</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">x2</span><span class="o">=</span><span class="n">x2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">m1</span><span class="o">=</span><span class="n">m1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">m2</span><span class="o">=</span><span class="n">m2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">x1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">centerx</span><span class="o">=</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">centery</span><span class="o">=</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">th</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">trans</span><span class="o">=</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">tmatrix</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=-</span><span class="n">centerx</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">centery</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">centerx</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=-</span><span class="n">centerx</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">-</span><span class="n">centery</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">)</span><span class="o">+</span><span class="n">centery</span><span class="o">+</span><span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tmatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">tform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">SimilarityTransform</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">)</span>
        <span class="n">x2rt</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">tform</span><span class="p">)</span>
        <span class="n">m2rt</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">m2</span><span class="p">,</span><span class="n">tform</span><span class="p">)</span>
        <span class="n">dist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_with_masks</span><span class="p">(</span><span class="n">x1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">x2rt</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">m1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">m2rt</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
        <span class="c1">#dist=self.dist(x1.flatten(),x2.flatten())</span>
        <span class="k">return</span> <span class="n">dist</span>

    <span class="k">def</span> <span class="nf">get_minRT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">,</span><span class="n">nth</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span><span class="n">dth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">dx</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nth</span><span class="o">%</span><span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">nth</span><span class="o">=</span><span class="n">nth</span><span class="o">+</span><span class="mi">1</span> <span class="c1">#should be zero in the set!</span>
        <span class="n">thSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">dth</span><span class="p">,</span><span class="n">dth</span><span class="p">,</span><span class="n">nth</span><span class="p">)</span>
        <span class="n">distSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nth</span><span class="p">):</span>
           <span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">thSet</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span>
           <span class="n">distSet</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_pair_distRT</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">m1</span><span class="p">,</span><span class="n">m2</span><span class="p">)</span>
        <span class="n">distSet</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">distSet</span><span class="p">))]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">thmin</span><span class="o">=</span><span class="n">thSet</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distSet</span><span class="p">)]</span>
        <span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">thmin</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
        <span class="c1">#tmin=minimize(self.get_pair_distRT,t,args=(m1,m2,m1,m2),method=&#39;L-BFGS-B&#39;,bounds=((-dth,dth),(-dx,dx),(-dx,dx)))</span>
        <span class="c1">#t=tmin.x</span>
        <span class="c1">#dist=self.get_pair_distRT(t,x1,x2,m1,m2)</span>
        <span class="k">return</span> <span class="n">t</span>

    <span class="k">def</span> <span class="nf">get_stack_trans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mskSet</span><span class="p">):</span>
        <span class="n">nframes</span><span class="o">=</span><span class="n">mskSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nframes</span><span class="p">):</span>
            <span class="n">msk0</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">iS</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
            <span class="n">centers0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">msk0</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">msk0</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">msk1</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,:,:]</span>
            <span class="n">centers1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">msk1</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">msk1</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="c1">#translate centers1 com to centers0 com</span>
            <span class="n">dcom</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">centers0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">centers1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">centers1</span><span class="o">=</span><span class="n">centers1</span><span class="o">-</span><span class="n">dcom</span>
            <span class="n">clusters0</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">AssignCenters</span><span class="p">(</span><span class="n">centers0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
            <span class="n">ind0to1</span><span class="o">=</span><span class="n">clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">centers1</span><span class="p">)</span>
            <span class="n">centers0_com</span><span class="o">=</span><span class="n">centers0</span><span class="p">[</span><span class="n">ind0to1</span><span class="p">,:]</span>
            <span class="n">dglobal</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">centers0_com</span><span class="o">-</span><span class="n">centers1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">centers1</span><span class="o">=</span><span class="n">centers1</span><span class="o">+</span><span class="n">dglobal</span>
            <span class="n">ind0to1g</span><span class="o">=</span><span class="n">clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">centers1</span><span class="p">)</span>
            <span class="n">centers0_global</span><span class="o">=</span><span class="n">centers0</span><span class="p">[</span><span class="n">ind0to1g</span><span class="p">,:]</span>
            <span class="c1">#tform = tf.estimate_transform(&#39;similarity&#39;, centers1, centers0_global)</span>
            <span class="n">t_global</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">t_global</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=-</span><span class="n">dcom</span><span class="o">+</span><span class="n">dglobal</span>
            <span class="n">msk1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_image</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">t_global</span><span class="p">)</span>
            <span class="n">t_local</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_minT</span><span class="p">(</span><span class="n">msk0</span><span class="p">,</span><span class="n">msk1</span><span class="p">,</span><span class="n">nt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ntrans</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maxtrans</span><span class="p">)</span>
            <span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,:]</span><span class="o">=</span><span class="n">t_global</span><span class="o">+</span><span class="n">t_local</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;transx: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; transy: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">visual</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">msk1</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,:,:]</span>
                <span class="n">msk1t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transform_image</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">])</span>
                <span class="n">msk0</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">iS</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">msk1t</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">msk0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">msk1</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">msk0</span><span class="p">,</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
        <span class="n">tSet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tSet</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tSet</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tSet</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tSet</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_stack_trans_turboreg</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="n">StackReg</span><span class="p">(</span><span class="n">StackReg</span><span class="o">.</span><span class="n">TRANSLATION</span><span class="p">)</span>
        <span class="n">tmats</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">register_stack</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="s1">&#39;previous&#39;</span><span class="p">)</span>
        <span class="n">nframes</span><span class="o">=</span><span class="n">tmats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iframe</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nframes</span><span class="p">):</span>
            <span class="n">tmatrix</span><span class="o">=</span><span class="n">tmats</span><span class="p">[</span><span class="n">iframe</span><span class="p">,:,:]</span>
            <span class="c1">#th=np.arctan2(-tmatrix[0,1],tmatrix[0,0])</span>
            <span class="n">tSet</span><span class="p">[</span><span class="n">iframe</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">tSet</span><span class="p">[</span><span class="n">iframe</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">tmatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;transx: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">iframe</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; transy: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">iframe</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tSet</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_stack_trans_frompoints</span><span class="p">(</span><span class="n">mskSet</span><span class="p">):</span>
        <span class="n">nframes</span><span class="o">=</span><span class="n">mskSet</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nframes</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nframes</span><span class="p">):</span>
            <span class="n">msk0</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">iS</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:]</span>
            <span class="n">centers0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">msk0</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">msk0</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">msk1</span><span class="o">=</span><span class="n">mskSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,:,:]</span>
            <span class="n">centers1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">msk1</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">msk1</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)))</span>
            <span class="n">clusters0</span><span class="o">=</span><span class="n">pyemma</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">AssignCenters</span><span class="p">(</span><span class="n">centers0</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
            <span class="n">ind0to1</span><span class="o">=</span><span class="n">clusters0</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">centers1</span><span class="p">)</span>
            <span class="n">centers0</span><span class="o">=</span><span class="n">centers0</span><span class="p">[</span><span class="n">ind0to1</span><span class="p">,:]</span>
            <span class="n">tform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">estimate_transform</span><span class="p">(</span><span class="s1">&#39;similarity&#39;</span><span class="p">,</span> <span class="n">centers1</span><span class="p">,</span> <span class="n">centers0</span><span class="p">)</span>
            <span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">tform</span><span class="o">.</span><span class="n">translation</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;transx: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; transy: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tSet</span><span class="p">[</span><span class="n">iS</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tSet</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_borders</span><span class="p">(</span><span class="n">msk</span><span class="p">):</span>
        <span class="n">cellborders</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">msk</span><span class="p">))):</span>
            <span class="n">cmsk</span><span class="o">=</span><span class="n">msk</span><span class="o">==</span><span class="n">ic</span>
            <span class="n">cborder</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">borders</span><span class="p">(</span><span class="n">cmsk</span><span class="p">)</span>
            <span class="n">cellborders</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cellborders</span><span class="p">,</span><span class="n">cborder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cellborders</span>

    <span class="k">def</span> <span class="nf">get_cc_cs_border</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mskcell</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">,</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">border</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_borders</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">bordercoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">border</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">nb</span><span class="o">=</span><span class="n">bordercoords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">fmskcell</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">fmskcell</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">fmskcell</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">fmskcell</span><span class="p">)</span>
        <span class="n">bg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">fmskcell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bg</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bgcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bg</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bgcoords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.e10</span><span class="p">,</span><span class="mf">1.e10</span><span class="p">]])</span>
        <span class="n">distbg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dmat</span><span class="p">(</span><span class="n">bordercoords</span><span class="p">,</span><span class="n">bgcoords</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ccborder</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">distbg</span><span class="o">&gt;</span><span class="n">bordersize</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">distbg</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">distbg</span><span class="p">))</span>
        <span class="n">indcc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)</span>
        <span class="n">indcs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ccborder</span><span class="p">))</span>
        <span class="n">indborder</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">border</span><span class="p">)</span>
        <span class="n">ccborder</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
        <span class="n">csborder</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mskcell</span><span class="p">)</span>
        <span class="n">ccborder</span><span class="p">[(</span><span class="n">indborder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indcc</span><span class="p">],</span><span class="n">indborder</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">indcc</span><span class="p">])]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">csborder</span><span class="p">[(</span><span class="n">indborder</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indcs</span><span class="p">],</span><span class="n">indborder</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">indcs</span><span class="p">])]</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="n">ccborder</span><span class="o">=</span><span class="n">ccborder</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">csborder</span><span class="o">=</span><span class="n">csborder</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ccborder</span><span class="p">,</span><span class="n">csborder</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_border_profile</span><span class="p">(</span><span class="n">imgcell</span><span class="p">,</span><span class="n">mskcell</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">,</span><span class="n">bordersize</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">cc_profile</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">bordersize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cs_profile</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">bordersize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cbins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">bordersize</span><span class="p">,</span><span class="n">bordersize</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fmskcell</span><span class="o">=</span><span class="n">fmskcell</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">fmskcell</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">fmskcell</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">fmskcell</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">fmskcell</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">fmskcell</span><span class="p">)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">i0</span><span class="o">=</span><span class="n">bordersize</span>
        <span class="n">ccborder</span><span class="p">,</span><span class="n">csborder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">mskcell</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">)</span>
        <span class="n">cc_profile</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborder</span><span class="p">)])</span>
        <span class="n">cs_profile</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborder</span><span class="p">)])</span>
        <span class="n">icp</span><span class="o">=</span><span class="n">bordersize</span><span class="p">;</span> <span class="n">icm</span><span class="o">=</span><span class="n">bordersize</span>
        <span class="n">mskcellp</span><span class="o">=</span><span class="n">mskcell</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span> <span class="n">mskcellm</span><span class="o">=</span><span class="n">mskcell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bordersize</span><span class="p">):</span>
            <span class="n">icp</span><span class="o">=</span><span class="n">icp</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">icm</span><span class="o">=</span><span class="n">icm</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">mskcellp</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">dilate</span><span class="p">(</span><span class="n">mskcellp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span><span class="n">se</span><span class="p">)</span>
            <span class="n">mskcellm</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">morph</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">mskcellm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span><span class="n">se</span><span class="p">)</span>
            <span class="n">ccborderp</span><span class="p">,</span><span class="n">csborderp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">mskcellp</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">)</span>
            <span class="n">ccborderm</span><span class="p">,</span><span class="n">csborderm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cc_cs_border</span><span class="p">(</span><span class="n">mskcellm</span><span class="p">,</span><span class="n">fmskcell</span><span class="p">)</span>
            <span class="n">cc_profile</span><span class="p">[</span><span class="n">icp</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborderp</span><span class="p">)])</span>
            <span class="n">cc_profile</span><span class="p">[</span><span class="n">icm</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ccborderm</span><span class="p">)])</span>
            <span class="n">cs_profile</span><span class="p">[</span><span class="n">icp</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborderp</span><span class="p">)])</span>
            <span class="n">cs_profile</span><span class="p">[</span><span class="n">icm</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imgcell</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">csborderm</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">cbins</span><span class="p">,</span><span class="n">cc_profile</span><span class="p">,</span><span class="n">cs_profile</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">seq_in_seq</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">full</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>   <span class="c1">#return f.find(s) #&lt;-- not reliable for finding indices in all cases</span>
        <span class="k">return</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">f</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_cell_bunches</span><span class="p">(</span><span class="n">fmsk</span><span class="p">,</span><span class="n">bunchcut</span><span class="o">=</span><span class="mf">100.0</span><span class="o">*</span><span class="mf">100.0</span><span class="p">):</span>
        <span class="n">bunches</span><span class="p">,</span><span class="n">nr0</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">fmsk</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">bool</span><span class="p">))</span>
        <span class="n">bunch_sizes</span><span class="o">=</span><span class="n">mahotas</span><span class="o">.</span><span class="n">labeled</span><span class="o">.</span><span class="n">labeled_size</span><span class="p">(</span><span class="n">bunches</span><span class="p">)</span>
        <span class="n">indbunches</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bunch_sizes</span><span class="o">&gt;</span><span class="n">bunchcut</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bmsk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fmsk</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">iib</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="n">indbunches</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">indb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bunches</span><span class="o">==</span><span class="n">ib</span><span class="p">)</span>
            <span class="n">bmsk</span><span class="p">[</span><span class="n">indb</span><span class="p">]</span><span class="o">=</span><span class="n">iib</span>
            <span class="n">iib</span><span class="o">=</span><span class="n">iib</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">bmsk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_clean_mask</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span><span class="n">minsize</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="n">cmsk</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
        <span class="n">indc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">msk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">msk</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)])</span>
        <span class="n">iic</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">indc</span><span class="p">:</span>
            <span class="n">indc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">msk</span><span class="o">==</span><span class="n">ic</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="o">==</span><span class="n">ic</span><span class="p">)</span><span class="o">&gt;</span><span class="n">minsize</span><span class="p">:</span>
                <span class="n">cmsk</span><span class="p">[</span><span class="n">indc</span><span class="p">]</span><span class="o">=</span><span class="n">iic</span>
                <span class="n">iic</span><span class="o">=</span><span class="n">iic</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">cmsk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_bunch_clusters</span><span class="p">(</span><span class="n">bmsk</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span> <span class="c1">#relative untranslated positions in image</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">bmsk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">bmsk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">),</span><span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">nb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bmsk</span><span class="p">)</span>
        <span class="n">cbSet</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nb</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ib</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb</span><span class="p">):</span>
            <span class="n">msk</span><span class="o">=</span><span class="n">bmsk</span><span class="o">==</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">cbSet</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">msk</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">cbSet</span><span class="p">[</span><span class="n">ib</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">msk</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span><span class="o">-</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">bunch_clusters</span><span class="o">=</span><span class="n">coor</span><span class="o">.</span><span class="n">clustering</span><span class="o">.</span><span class="n">AssignCenters</span><span class="p">(</span><span class="n">cbSet</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bunch_clusters</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Jeremy Copperman.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>